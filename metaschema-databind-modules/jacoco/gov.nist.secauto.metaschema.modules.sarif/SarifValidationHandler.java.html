<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SarifValidationHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Metaschema Modules</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.metaschema.modules.sarif</a> &gt; <span class="el_source">SarifValidationHandler.java</span></div><h1>SarifValidationHandler.java</h1><pre class="source lang-java linenums">/*
 * SPDX-FileCopyrightText: none
 * SPDX-License-Identifier: CC0-1.0
 */

package gov.nist.secauto.metaschema.modules.sarif;

import gov.nist.secauto.metaschema.core.datatype.markup.MarkupLine;
import gov.nist.secauto.metaschema.core.datatype.markup.MarkupMultiline;
import gov.nist.secauto.metaschema.core.model.IAttributable;
import gov.nist.secauto.metaschema.core.model.IResourceLocation;
import gov.nist.secauto.metaschema.core.model.constraint.ConstraintValidationFinding;
import gov.nist.secauto.metaschema.core.model.constraint.IConstraint;
import gov.nist.secauto.metaschema.core.model.constraint.IConstraint.Level;
import gov.nist.secauto.metaschema.core.model.validation.IValidationFinding;
import gov.nist.secauto.metaschema.core.model.validation.JsonSchemaContentValidator.JsonValidationFinding;
import gov.nist.secauto.metaschema.core.model.validation.XmlSchemaContentValidator.XmlValidationFinding;
import gov.nist.secauto.metaschema.core.util.CollectionUtil;
import gov.nist.secauto.metaschema.core.util.IVersionInfo;
import gov.nist.secauto.metaschema.core.util.ObjectUtils;
import gov.nist.secauto.metaschema.core.util.UriUtils;
import gov.nist.secauto.metaschema.databind.IBindingContext;
import gov.nist.secauto.metaschema.databind.io.Format;
import gov.nist.secauto.metaschema.databind.io.SerializationFeature;

import org.schemastore.json.sarif.x210.Artifact;
import org.schemastore.json.sarif.x210.ArtifactLocation;
import org.schemastore.json.sarif.x210.Location;
import org.schemastore.json.sarif.x210.LogicalLocation;
import org.schemastore.json.sarif.x210.Message;
import org.schemastore.json.sarif.x210.MultiformatMessageString;
import org.schemastore.json.sarif.x210.PhysicalLocation;
import org.schemastore.json.sarif.x210.Region;
import org.schemastore.json.sarif.x210.ReportingDescriptor;
import org.schemastore.json.sarif.x210.Result;
import org.schemastore.json.sarif.x210.Run;
import org.schemastore.json.sarif.x210.Sarif;
import org.schemastore.json.sarif.x210.SarifModule;
import org.schemastore.json.sarif.x210.Tool;
import org.schemastore.json.sarif.x210.ToolComponent;

import java.io.IOException;
import java.math.BigInteger;
import java.net.URI;
import java.net.URISyntaxException;
import java.nio.file.Path;
import java.nio.file.StandardOpenOption;
import java.util.Collection;
import java.util.LinkedHashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.UUID;
import java.util.concurrent.atomic.AtomicInteger;

import edu.umd.cs.findbugs.annotations.NonNull;
import edu.umd.cs.findbugs.annotations.Nullable;

/**
 * Supports building a Static Analysis Results Interchange Format (SARIF)
 * document based on a set of validation findings.
 */
@SuppressWarnings(&quot;PMD.CouplingBetweenObjects&quot;)
public final class SarifValidationHandler {
<span class="fc" id="L66">  private enum Kind {</span>
<span class="fc" id="L67">    NOT_APPLICABLE(&quot;notApplicable&quot;),</span>
<span class="fc" id="L68">    PASS(&quot;pass&quot;),</span>
<span class="fc" id="L69">    FAIL(&quot;fail&quot;),</span>
<span class="fc" id="L70">    REVIEW(&quot;review&quot;),</span>
<span class="fc" id="L71">    OPEN(&quot;open&quot;),</span>
<span class="fc" id="L72">    INFORMATIONAL(&quot;informational&quot;);</span>

    @NonNull
    private final String label;

<span class="fc" id="L77">    Kind(@NonNull String label) {</span>
<span class="fc" id="L78">      this.label = label;</span>
<span class="fc" id="L79">    }</span>

    @NonNull
    public String getLabel() {
<span class="fc" id="L83">      return label;</span>
    }
  }

<span class="fc" id="L87">  private enum SeverityLevel {</span>
<span class="fc" id="L88">    NONE(&quot;none&quot;),</span>
<span class="fc" id="L89">    NOTE(&quot;note&quot;),</span>
<span class="fc" id="L90">    WARNING(&quot;warning&quot;),</span>
<span class="fc" id="L91">    ERROR(&quot;error&quot;);</span>

    @NonNull
    private final String label;

<span class="fc" id="L96">    SeverityLevel(@NonNull String label) {</span>
<span class="fc" id="L97">      this.label = label;</span>
<span class="fc" id="L98">    }</span>

    @NonNull
    public String getLabel() {
<span class="fc" id="L102">      return label;</span>
    }
  }

  @NonNull
  static final String SARIF_NS = &quot;https://docs.oasis-open.org/sarif/sarif/v2.1.0&quot;;
  @NonNull
<span class="fc" id="L109">  static final IAttributable.Key SARIF_HELP_URL_KEY</span>
<span class="fc" id="L110">      = IAttributable.key(&quot;help-url&quot;, SARIF_NS);</span>
  @NonNull
<span class="fc" id="L112">  static final IAttributable.Key SARIF_HELP_TEXT_KEY</span>
<span class="fc" id="L113">      = IAttributable.key(&quot;help-text&quot;, SARIF_NS);</span>
  @NonNull
<span class="fc" id="L115">  static final IAttributable.Key SARIF_HELP_MARKDOWN_KEY</span>
<span class="fc" id="L116">      = IAttributable.key(&quot;help-markdown&quot;, SARIF_NS);</span>

  @NonNull
  private final URI source;
  @Nullable
  private final IVersionInfo toolVersion;
<span class="fc" id="L122">  private final AtomicInteger artifactIndex = new AtomicInteger(-1);</span>
<span class="fc" id="L123">  private final AtomicInteger ruleIndex = new AtomicInteger(-1);</span>

<span class="fc" id="L125">  @SuppressWarnings(&quot;PMD.UseConcurrentHashMap&quot;)</span>
  @NonNull
  private final Map&lt;URI, ArtifactRecord&gt; artifacts = new LinkedHashMap&lt;&gt;();
<span class="fc" id="L128">  @NonNull</span>
  private final List&lt;AbstractRuleRecord&gt; rules = new LinkedList&lt;&gt;();
<span class="fc" id="L130">  @SuppressWarnings(&quot;PMD.UseConcurrentHashMap&quot;)</span>
  @NonNull
  private final Map&lt;IConstraint, ConstraintRuleRecord&gt; constraintRules = new LinkedHashMap&lt;&gt;();
<span class="fc" id="L133">  @NonNull</span>
  private final List&lt;IResult&gt; results = new LinkedList&lt;&gt;();
<span class="fc" id="L135">  @NonNull</span>
  private final SchemaRuleRecord schemaRule = new SchemaRuleRecord();
<span class="fc" id="L137">  private boolean schemaValid = true;</span>

  /**
   * Construct a new validation handler.
   *
   * @param source
   *          the URI of the content that was validated
   * @param toolVersion
   *          the version information for the tool producing the validation
   *          results
   */
  public SarifValidationHandler(
      @NonNull URI source,
<span class="fc" id="L150">      @Nullable IVersionInfo toolVersion) {</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">    if (!source.isAbsolute()) {</span>
<span class="nc" id="L152">      throw new IllegalArgumentException(String.format(&quot;The source URI '%s' is not absolute.&quot;, source.toASCIIString()));</span>
    }

<span class="fc" id="L155">    this.source = source;</span>
<span class="fc" id="L156">    this.toolVersion = toolVersion;</span>
<span class="fc" id="L157">  }</span>

  @NonNull
  private URI getSource() {
<span class="fc" id="L161">    return source;</span>
  }

  private IVersionInfo getToolVersion() {
<span class="fc" id="L165">    return toolVersion;</span>
  }

  /**
   * Register a collection of validation finding.
   *
   * @param findings
   *          the findings to register
   */
  public void addFindings(@NonNull Collection&lt;? extends IValidationFinding&gt; findings) {
<span class="nc bnc" id="L175" title="All 2 branches missed.">    for (IValidationFinding finding : findings) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">      assert finding != null;</span>
<span class="nc" id="L177">      addFinding(finding);</span>
<span class="nc" id="L178">    }</span>
<span class="nc" id="L179">  }</span>

  /**
   * Register a validation finding.
   *
   * @param finding
   *          the finding to register
   */
  public void addFinding(@NonNull IValidationFinding finding) {
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">    if (finding instanceof JsonValidationFinding) {</span>
<span class="nc" id="L189">      addJsonValidationFinding((JsonValidationFinding) finding);</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">    } else if (finding instanceof XmlValidationFinding) {</span>
<span class="nc" id="L191">      addXmlValidationFinding((XmlValidationFinding) finding);</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">    } else if (finding instanceof ConstraintValidationFinding) {</span>
<span class="fc" id="L193">      addConstraintValidationFinding((ConstraintValidationFinding) finding);</span>
    } else {
<span class="nc" id="L195">      throw new IllegalStateException();</span>
    }
<span class="fc" id="L197">  }</span>

  private ConstraintRuleRecord getRuleRecord(@NonNull IConstraint constraint) {
<span class="fc" id="L200">    ConstraintRuleRecord retval = constraintRules.get(constraint);</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">    if (retval == null) {</span>
<span class="fc" id="L202">      retval = new ConstraintRuleRecord(constraint);</span>
<span class="fc" id="L203">      constraintRules.put(constraint, retval);</span>
<span class="fc" id="L204">      rules.add(retval);</span>
    }
<span class="fc" id="L206">    return retval;</span>
  }

  private ArtifactRecord getArtifactRecord(@NonNull URI artifactUri) {
<span class="fc" id="L210">    ArtifactRecord retval = artifacts.get(artifactUri);</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">    if (retval == null) {</span>
<span class="fc" id="L212">      retval = new ArtifactRecord(artifactUri);</span>
<span class="fc" id="L213">      artifacts.put(artifactUri, retval);</span>
    }
<span class="fc" id="L215">    return retval;</span>
  }

  private void addJsonValidationFinding(@NonNull JsonValidationFinding finding) {
<span class="nc" id="L219">    results.add(new SchemaResult(finding));</span>
<span class="nc bnc" id="L220" title="All 4 branches missed.">    if (schemaValid &amp;&amp; IValidationFinding.Kind.FAIL.equals(finding.getKind())) {</span>
<span class="nc" id="L221">      schemaValid = false;</span>
    }
<span class="nc" id="L223">  }</span>

  private void addXmlValidationFinding(@NonNull XmlValidationFinding finding) {
<span class="nc" id="L226">    results.add(new SchemaResult(finding));</span>
<span class="nc bnc" id="L227" title="All 4 branches missed.">    if (schemaValid &amp;&amp; IValidationFinding.Kind.FAIL.equals(finding.getKind())) {</span>
<span class="nc" id="L228">      schemaValid = false;</span>
    }
<span class="nc" id="L230">  }</span>

  private void addConstraintValidationFinding(@NonNull ConstraintValidationFinding finding) {
<span class="fc" id="L233">    results.add(new ConstraintResult(finding));</span>
<span class="fc" id="L234">  }</span>

  /**
   * Write the collection of findings to the provided output file.
   *
   * @param outputFile
   *          the path to the output file to write to
   * @param bindingContext
   *          the context used to access Metaschema module information based on
   *          Java class bindings
   * @throws IOException
   *           if an error occurred while writing the SARIF file
   */
  public void write(
      @NonNull Path outputFile,
      @NonNull IBindingContext bindingContext) throws IOException {

<span class="fc" id="L251">    URI output = ObjectUtils.notNull(outputFile.toUri());</span>

<span class="fc" id="L253">    Sarif sarif = new Sarif();</span>
<span class="fc" id="L254">    sarif.setVersion(&quot;2.1.0&quot;);</span>

<span class="fc" id="L256">    Run run = new Run();</span>

<span class="fc" id="L258">    sarif.addRun(run);</span>

<span class="fc" id="L260">    Artifact artifact = new Artifact();</span>

<span class="fc" id="L262">    artifact.setLocation(getArtifactRecord(getSource()).generateArtifactLocation(output));</span>

<span class="fc" id="L264">    run.addArtifact(artifact);</span>

<span class="fc bfc" id="L266" title="All 2 branches covered.">    for (IResult result : results) {</span>
<span class="fc" id="L267">      result.generateResults(output).forEach(run::addResult);</span>
<span class="fc" id="L268">    }</span>

<span class="fc" id="L270">    IVersionInfo toolVersion = getToolVersion();</span>
<span class="pc bpc" id="L271" title="3 of 4 branches missed.">    if (!rules.isEmpty() || toolVersion != null) {</span>
<span class="fc" id="L272">      Tool tool = new Tool();</span>
<span class="fc" id="L273">      ToolComponent driver = new ToolComponent();</span>

<span class="pc bpc" id="L275" title="1 of 2 branches missed.">      if (toolVersion != null) {</span>
<span class="fc" id="L276">        driver.setName(toolVersion.getName());</span>
<span class="fc" id="L277">        driver.setVersion(toolVersion.getVersion());</span>
      }

<span class="fc bfc" id="L280" title="All 2 branches covered.">      for (AbstractRuleRecord rule : rules) {</span>
<span class="fc" id="L281">        driver.addRule(rule.generate());</span>
<span class="fc" id="L282">      }</span>

<span class="fc" id="L284">      tool.setDriver(driver);</span>
<span class="fc" id="L285">      run.setTool(tool);</span>
    }

<span class="fc" id="L288">    bindingContext.registerModule(SarifModule.class);</span>
<span class="fc" id="L289">    bindingContext.newSerializer(Format.JSON, Sarif.class)</span>
<span class="fc" id="L290">        .disableFeature(SerializationFeature.SERIALIZE_ROOT)</span>
<span class="fc" id="L291">        .serialize(</span>
            sarif,
            outputFile,
            StandardOpenOption.CREATE,
            StandardOpenOption.WRITE,
            StandardOpenOption.TRUNCATE_EXISTING);
<span class="fc" id="L297">  }</span>

  private interface IResult {
    @NonNull
    IValidationFinding getFinding();

    @NonNull
    List&lt;Result&gt; generateResults(@NonNull URI output) throws IOException;
  }

  private abstract class AbstractResult&lt;T extends IValidationFinding&gt; implements IResult {
    @NonNull
    private final T finding;

<span class="fc" id="L311">    protected AbstractResult(@NonNull T finding) {</span>
<span class="fc" id="L312">      this.finding = finding;</span>
<span class="fc" id="L313">    }</span>

    @Override
    public T getFinding() {
<span class="fc" id="L317">      return finding;</span>
    }

    @NonNull
    protected Kind kind(@NonNull IValidationFinding finding) {
<span class="fc" id="L322">      IValidationFinding.Kind kind = finding.getKind();</span>

      Kind retval;
<span class="pc bpc" id="L325" title="4 of 5 branches missed.">      switch (kind) {</span>
      case FAIL:
<span class="fc" id="L327">        retval = Kind.FAIL;</span>
<span class="fc" id="L328">        break;</span>
      case INFORMATIONAL:
<span class="nc" id="L330">        retval = Kind.INFORMATIONAL;</span>
<span class="nc" id="L331">        break;</span>
      case NOT_APPLICABLE:
<span class="nc" id="L333">        retval = Kind.NOT_APPLICABLE;</span>
<span class="nc" id="L334">        break;</span>
      case PASS:
<span class="nc" id="L336">        retval = Kind.PASS;</span>
<span class="nc" id="L337">        break;</span>
      default:
<span class="nc" id="L339">        throw new IllegalArgumentException(String.format(&quot;Invalid finding kind '%s'.&quot;, kind));</span>
      }
<span class="fc" id="L341">      return retval;</span>
    }

    @NonNull
    protected SeverityLevel level(@NonNull Level severity) {
      SeverityLevel retval;
<span class="pc bpc" id="L347" title="4 of 5 branches missed.">      switch (severity) {</span>
      case CRITICAL:
      case ERROR:
<span class="fc" id="L350">        retval = SeverityLevel.ERROR;</span>
<span class="fc" id="L351">        break;</span>
      case INFORMATIONAL:
      case DEBUG:
<span class="nc" id="L354">        retval = SeverityLevel.NOTE;</span>
<span class="nc" id="L355">        break;</span>
      case WARNING:
<span class="nc" id="L357">        retval = SeverityLevel.WARNING;</span>
<span class="nc" id="L358">        break;</span>
      case NONE:
<span class="nc" id="L360">        retval = SeverityLevel.NONE;</span>
<span class="nc" id="L361">        break;</span>
      default:
<span class="nc" id="L363">        throw new IllegalArgumentException(String.format(&quot;Invalid severity '%s'.&quot;, severity));</span>
      }
<span class="fc" id="L365">      return retval;</span>
    }

    protected void message(@NonNull IValidationFinding finding, @NonNull Result result) {
<span class="fc" id="L369">      String message = finding.getMessage();</span>
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">      if (message == null) {</span>
<span class="fc" id="L371">        message = &quot;&quot;;</span>
      }

<span class="fc" id="L374">      Message msg = new Message();</span>
<span class="fc" id="L375">      msg.setText(message);</span>
<span class="fc" id="L376">      result.setMessage(msg);</span>
<span class="fc" id="L377">    }</span>

    protected void location(@NonNull IValidationFinding finding, @NonNull Result result, @NonNull URI base)
        throws IOException {
<span class="fc" id="L381">      IResourceLocation location = finding.getLocation();</span>
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">      if (location != null) {</span>
        // region
<span class="fc" id="L384">        Region region = new Region();</span>

<span class="pc bpc" id="L386" title="1 of 2 branches missed.">        if (location.getLine() &gt; -1) {</span>
<span class="fc" id="L387">          region.setStartLine(BigInteger.valueOf(location.getLine()));</span>
<span class="fc" id="L388">          region.setEndLine(BigInteger.valueOf(location.getLine()));</span>
        }
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">        if (location.getColumn() &gt; -1) {</span>
<span class="fc" id="L391">          region.setStartColumn(BigInteger.valueOf(location.getColumn() + 1));</span>
<span class="fc" id="L392">          region.setEndColumn(BigInteger.valueOf(location.getColumn() + 1));</span>
        }
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">        if (location.getByteOffset() &gt; -1) {</span>
<span class="fc" id="L395">          region.setByteOffset(BigInteger.valueOf(location.getByteOffset()));</span>
<span class="fc" id="L396">          region.setByteLength(BigInteger.ZERO);</span>
        }
<span class="pc bpc" id="L398" title="1 of 2 branches missed.">        if (location.getCharOffset() &gt; -1) {</span>
<span class="fc" id="L399">          region.setCharOffset(BigInteger.valueOf(location.getCharOffset()));</span>
<span class="fc" id="L400">          region.setCharLength(BigInteger.ZERO);</span>
        }

<span class="fc" id="L403">        PhysicalLocation physical = new PhysicalLocation();</span>

<span class="fc" id="L405">        URI documentUri = finding.getDocumentUri();</span>
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">        if (documentUri != null) {</span>
<span class="fc" id="L407">          physical.setArtifactLocation(getArtifactRecord(documentUri).generateArtifactLocation(base));</span>
        }
<span class="fc" id="L409">        physical.setRegion(region);</span>

<span class="fc" id="L411">        LogicalLocation logical = new LogicalLocation();</span>

<span class="fc" id="L413">        logical.setDecoratedName(finding.getPath());</span>

<span class="fc" id="L415">        Location loc = new Location();</span>
<span class="fc" id="L416">        loc.setPhysicalLocation(physical);</span>
<span class="fc" id="L417">        loc.setLogicalLocation(logical);</span>
<span class="fc" id="L418">        result.addLocation(loc);</span>
      }
<span class="fc" id="L420">    }</span>
  }

  private final class SchemaResult
      extends AbstractResult&lt;IValidationFinding&gt; {

<span class="nc" id="L426">    protected SchemaResult(@NonNull IValidationFinding finding) {</span>
<span class="nc" id="L427">      super(finding);</span>
<span class="nc" id="L428">    }</span>

    @Override
    public List&lt;Result&gt; generateResults(@NonNull URI output) throws IOException {
<span class="nc" id="L432">      IValidationFinding finding = getFinding();</span>

<span class="nc" id="L434">      Result result = new Result();</span>

<span class="nc" id="L436">      result.setRuleId(schemaRule.getId());</span>
<span class="nc" id="L437">      result.setRuleIndex(BigInteger.valueOf(schemaRule.getIndex()));</span>
<span class="nc" id="L438">      result.setGuid(schemaRule.getGuid());</span>

<span class="nc" id="L440">      result.setKind(kind(finding).getLabel());</span>
<span class="nc" id="L441">      result.setLevel(level(finding.getSeverity()).getLabel());</span>
<span class="nc" id="L442">      message(finding, result);</span>
<span class="nc" id="L443">      location(finding, result, output);</span>

<span class="nc" id="L445">      return CollectionUtil.singletonList(result);</span>
    }
  }

<span class="fc" id="L449">  private final class ConstraintResult</span>
      extends AbstractResult&lt;ConstraintValidationFinding&gt; {

<span class="fc" id="L452">    protected ConstraintResult(@NonNull ConstraintValidationFinding finding) {</span>
<span class="fc" id="L453">      super(finding);</span>
<span class="fc" id="L454">    }</span>

    @Override
    public List&lt;Result&gt; generateResults(@NonNull URI output) throws IOException {
<span class="fc" id="L458">      ConstraintValidationFinding finding = getFinding();</span>

<span class="fc" id="L460">      List&lt;Result&gt; retval = new LinkedList&lt;&gt;();</span>

<span class="fc" id="L462">      Kind kind = kind(finding);</span>
<span class="fc" id="L463">      SeverityLevel level = level(finding.getSeverity());</span>

<span class="fc bfc" id="L465" title="All 2 branches covered.">      for (IConstraint constraint : finding.getConstraints()) {</span>
<span class="pc bpc" id="L466" title="1 of 2 branches missed.">        assert constraint != null;</span>
<span class="fc" id="L467">        ConstraintRuleRecord rule = getRuleRecord(constraint);</span>

        @SuppressWarnings(&quot;PMD.AvoidInstantiatingObjectsInLoops&quot;)
<span class="fc" id="L470">        Result result = new Result();</span>

<span class="fc" id="L472">        String id = constraint.getId();</span>
<span class="pc bpc" id="L473" title="1 of 2 branches missed.">        if (id != null) {</span>
<span class="nc" id="L474">          result.setRuleId(id);</span>
        }
<span class="fc" id="L476">        result.setRuleIndex(BigInteger.valueOf(rule.getIndex()));</span>
<span class="fc" id="L477">        result.setGuid(rule.getGuid());</span>
<span class="fc" id="L478">        result.setKind(kind.getLabel());</span>
<span class="fc" id="L479">        result.setLevel(level.getLabel());</span>
<span class="fc" id="L480">        message(finding, result);</span>
<span class="fc" id="L481">        location(finding, result, output);</span>

<span class="fc" id="L483">        retval.add(result);</span>
<span class="fc" id="L484">      }</span>
<span class="fc" id="L485">      return retval;</span>
    }
  }

  private abstract class AbstractRuleRecord {
    private final int index;
    @NonNull
    private final UUID guid;

<span class="fc" id="L494">    private AbstractRuleRecord() {</span>
<span class="fc" id="L495">      this.index = ruleIndex.addAndGet(1);</span>
<span class="fc" id="L496">      this.guid = ObjectUtils.notNull(UUID.randomUUID());</span>
<span class="fc" id="L497">    }</span>

    public int getIndex() {
<span class="fc" id="L500">      return index;</span>
    }

    @NonNull
    public UUID getGuid() {
<span class="fc" id="L505">      return guid;</span>
    }

    @NonNull
    protected abstract ReportingDescriptor generate();
  }

<span class="fc" id="L512">  private final class SchemaRuleRecord</span>
      extends AbstractRuleRecord {

    @Override
    protected ReportingDescriptor generate() {
<span class="nc" id="L517">      ReportingDescriptor retval = new ReportingDescriptor();</span>
<span class="nc" id="L518">      retval.setId(getId());</span>
<span class="nc" id="L519">      retval.setGuid(getGuid());</span>
<span class="nc" id="L520">      return retval;</span>
    }

    public String getId() {
<span class="nc" id="L524">      return &quot;schema-valid&quot;;</span>
    }
  }

  private final class ConstraintRuleRecord
      extends AbstractRuleRecord {
    @NonNull
    private final IConstraint constraint;

<span class="fc" id="L533">    public ConstraintRuleRecord(@NonNull IConstraint constraint) {</span>
<span class="fc" id="L534">      this.constraint = constraint;</span>
<span class="fc" id="L535">    }</span>

    @NonNull
    public IConstraint getConstraint() {
<span class="fc" id="L539">      return constraint;</span>
    }

    @Override
    protected ReportingDescriptor generate() {
<span class="fc" id="L544">      ReportingDescriptor retval = new ReportingDescriptor();</span>
<span class="fc" id="L545">      IConstraint constraint = getConstraint();</span>

<span class="fc" id="L547">      UUID guid = getGuid();</span>

<span class="fc" id="L549">      String id = constraint.getId();</span>
<span class="pc bpc" id="L550" title="1 of 2 branches missed.">      if (id == null) {</span>
<span class="fc" id="L551">        retval.setId(guid.toString());</span>
      } else {
<span class="nc" id="L553">        retval.setId(id);</span>
      }
<span class="fc" id="L555">      retval.setGuid(guid);</span>
<span class="fc" id="L556">      String formalName = constraint.getFormalName();</span>
<span class="pc bpc" id="L557" title="1 of 2 branches missed.">      if (formalName != null) {</span>
<span class="fc" id="L558">        MultiformatMessageString text = new MultiformatMessageString();</span>
<span class="fc" id="L559">        text.setText(formalName);</span>
<span class="fc" id="L560">        retval.setShortDescription(text);</span>
      }
<span class="fc" id="L562">      MarkupLine description = constraint.getDescription();</span>
<span class="pc bpc" id="L563" title="1 of 2 branches missed.">      if (description != null) {</span>
<span class="fc" id="L564">        MultiformatMessageString text = new MultiformatMessageString();</span>
<span class="fc" id="L565">        text.setText(description.toText());</span>
<span class="fc" id="L566">        text.setMarkdown(description.toMarkdown());</span>
<span class="fc" id="L567">        retval.setFullDescription(text);</span>
      }

<span class="fc" id="L570">      Set&lt;String&gt; helpUrls = constraint.getPropertyValues(SARIF_HELP_URL_KEY);</span>
<span class="pc bpc" id="L571" title="1 of 2 branches missed.">      if (!helpUrls.isEmpty()) {</span>
<span class="fc" id="L572">        retval.setHelpUri(URI.create(helpUrls.stream().findFirst().get()));</span>
      }

<span class="fc" id="L575">      Set&lt;String&gt; helpText = constraint.getPropertyValues(SARIF_HELP_TEXT_KEY);</span>
<span class="fc" id="L576">      Set&lt;String&gt; helpMarkdown = constraint.getPropertyValues(SARIF_HELP_MARKDOWN_KEY);</span>
      // if there is help text or markdown, produce a message
<span class="pc bpc" id="L578" title="2 of 4 branches missed.">      if (!helpText.isEmpty() || !helpMarkdown.isEmpty()) {</span>
<span class="fc" id="L579">        MultiformatMessageString help = new MultiformatMessageString();</span>

<span class="fc" id="L581">        MarkupMultiline markdown = helpMarkdown.stream().map(MarkupMultiline::fromMarkdown).findFirst().orElse(null);</span>
<span class="pc bpc" id="L582" title="1 of 2 branches missed.">        if (markdown != null) {</span>
          // markdown is provided
<span class="fc" id="L584">          help.setMarkdown(markdown.toMarkdown());</span>
        }

<span class="pc bpc" id="L587" title="1 of 2 branches missed.">        String text = helpText.isEmpty()</span>
<span class="fc" id="L588">            ? ObjectUtils.requireNonNull(markdown).toText() // if text is empty, markdown must be provided</span>
<span class="pc" id="L589">            : helpText.stream().findFirst().get(); // use the provided text</span>
<span class="fc" id="L590">        help.setText(text);</span>

<span class="fc" id="L592">        retval.setHelp(help);</span>
      }

<span class="fc" id="L595">      return retval;</span>
    }

  }

  private final class ArtifactRecord {
    @NonNull
    private final URI uri;
    private final int index;

<span class="fc" id="L605">    public ArtifactRecord(@NonNull URI uri) {</span>
<span class="fc" id="L606">      this.uri = uri;</span>
<span class="fc" id="L607">      this.index = artifactIndex.addAndGet(1);</span>
<span class="fc" id="L608">    }</span>

    @NonNull
    public URI getUri() {
<span class="fc" id="L612">      return uri;</span>
    }

    public int getIndex() {
<span class="fc" id="L616">      return index;</span>
    }

    public ArtifactLocation generateArtifactLocation(@NonNull URI baseUri) throws IOException {
<span class="fc" id="L620">      ArtifactLocation location = new ArtifactLocation();</span>

      try {
<span class="fc" id="L623">        location.setUri(UriUtils.relativize(baseUri, getUri(), true));</span>
<span class="nc" id="L624">      } catch (URISyntaxException ex) {</span>
<span class="nc" id="L625">        throw new IOException(ex);</span>
<span class="fc" id="L626">      }</span>

<span class="fc" id="L628">      location.setIndex(BigInteger.valueOf(getIndex()));</span>
<span class="fc" id="L629">      return location;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>