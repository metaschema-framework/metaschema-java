<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InstanceModelChoiceGroup.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Metaschema Java Data Binding and Code Generation</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.metaschema.databind.model.impl</a> &gt; <span class="el_source">InstanceModelChoiceGroup.java</span></div><h1>InstanceModelChoiceGroup.java</h1><pre class="source lang-java linenums">/*
 * SPDX-FileCopyrightText: none
 * SPDX-License-Identifier: CC0-1.0
 */

package gov.nist.secauto.metaschema.databind.model.impl;

import gov.nist.secauto.metaschema.core.model.AbstractChoiceGroupInstance;
import gov.nist.secauto.metaschema.core.model.IBoundObject;
import gov.nist.secauto.metaschema.core.model.IContainerModelSupport;
import gov.nist.secauto.metaschema.core.util.CollectionUtil;
import gov.nist.secauto.metaschema.core.util.CustomCollectors;
import gov.nist.secauto.metaschema.core.util.ObjectUtils;
import gov.nist.secauto.metaschema.databind.model.IBoundDefinitionModelAssembly;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceFlag;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelChoiceGroup;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelGroupedAssembly;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelGroupedField;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelGroupedNamed;
import gov.nist.secauto.metaschema.databind.model.IBoundModule;
import gov.nist.secauto.metaschema.databind.model.IGroupAs;
import gov.nist.secauto.metaschema.databind.model.annotations.BoundChoiceGroup;
import gov.nist.secauto.metaschema.databind.model.annotations.BoundGroupedAssembly;
import gov.nist.secauto.metaschema.databind.model.annotations.BoundGroupedField;
import gov.nist.secauto.metaschema.databind.model.annotations.GroupAs;
import gov.nist.secauto.metaschema.databind.model.annotations.ModelUtil;
import gov.nist.secauto.metaschema.databind.model.info.IModelInstanceCollectionInfo;

import java.lang.reflect.Field;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Map.Entry;
import java.util.function.Function;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import javax.xml.namespace.QName;

import edu.umd.cs.findbugs.annotations.NonNull;
import edu.umd.cs.findbugs.annotations.Nullable;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import nl.talsmasoftware.lazy4j.Lazy;

/**
 * Implements a Metaschema module choice group instance bound to a Java field.
 */
@SuppressWarnings(&quot;PMD.CouplingBetweenObjects&quot;)
public final class InstanceModelChoiceGroup
    extends AbstractChoiceGroupInstance&lt;
        IBoundDefinitionModelAssembly,
        IBoundInstanceModelGroupedNamed,
        IBoundInstanceModelGroupedField,
        IBoundInstanceModelGroupedAssembly&gt;
    implements IBoundInstanceModelChoiceGroup,
    IFeatureBoundContainerModelChoiceGroup, IFeatureInstanceModelGroupAs&lt;IBoundObject&gt; {
  @NonNull
  private final Field javaField;
  @NonNull
  private final BoundChoiceGroup annotation;
  @NonNull
  private final Lazy&lt;IModelInstanceCollectionInfo&lt;IBoundObject&gt;&gt; collectionInfo;
  @NonNull
  private final IGroupAs groupAs;
  @NonNull
  private final Lazy&lt;ChoiceGroupModelContainerSupport&gt; modelContainer;
  @NonNull
  private final Lazy&lt;Map&lt;Class&lt;?&gt;, IBoundInstanceModelGroupedNamed&gt;&gt; classToInstanceMap;
  @NonNull
  private final Lazy&lt;Map&lt;QName, IBoundInstanceModelGroupedNamed&gt;&gt; qnameToInstanceMap;
  @NonNull
  private final Lazy&lt;Map&lt;String, IBoundInstanceModelGroupedNamed&gt;&gt; discriminatorToInstanceMap;

  /**
   * Construct a new Metaschema module choice group instance.
   *
   * @param javaField
   *          the Java field bound to this instance
   * @param parent
   *          the definition containing this instance
   * @return the instance
   */
  @NonNull
  public static InstanceModelChoiceGroup newInstance(
      @NonNull Field javaField,
      @NonNull IBoundDefinitionModelAssembly parent) {
<span class="fc" id="L89">    BoundChoiceGroup annotation = ModelUtil.getAnnotation(javaField, BoundChoiceGroup.class);</span>
<span class="fc" id="L90">    IGroupAs groupAs = ModelUtil.resolveDefaultGroupAs(annotation.groupAs(), parent.getContainingModule());</span>
<span class="pc bpc" id="L91" title="3 of 4 branches missed.">    if (annotation.maxOccurs() == -1 || annotation.maxOccurs() &gt; 1) {</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">      if (IGroupAs.SINGLETON_GROUP_AS.equals(groupAs)) {</span>
<span class="nc" id="L93">        throw new IllegalStateException(String.format(&quot;Field '%s' on class '%s' is missing the '%s' annotation.&quot;,</span>
<span class="nc" id="L94">            javaField.getName(),</span>
<span class="nc" id="L95">            parent.getBoundClass().getName(),</span>
<span class="nc" id="L96">            GroupAs.class.getName()));</span>
      }
<span class="nc bnc" id="L98" title="All 2 branches missed.">    } else if (!IGroupAs.SINGLETON_GROUP_AS.equals(groupAs)) {</span>
      // max is 1 and a groupAs is set
<span class="nc" id="L100">      throw new IllegalStateException(</span>
<span class="nc" id="L101">          String.format(</span>
              &quot;Field '%s' on class '%s' has the '%s' annotation, but maxOccurs=1. A groupAs must not be specfied.&quot;,
<span class="nc" id="L103">              javaField.getName(),</span>
<span class="nc" id="L104">              parent.getBoundClass().getName(),</span>
<span class="nc" id="L105">              GroupAs.class.getName()));</span>
    }
<span class="fc" id="L107">    return new InstanceModelChoiceGroup(javaField, annotation, groupAs, parent);</span>
  }

  @SuppressFBWarnings(value = &quot;CT_CONSTRUCTOR_THROW&quot;, justification = &quot;Use of final fields&quot;)
  private InstanceModelChoiceGroup(
      @NonNull Field javaField,
      @NonNull BoundChoiceGroup annotation,
      @NonNull IGroupAs groupAs,
      @NonNull IBoundDefinitionModelAssembly parent) {
<span class="fc" id="L116">    super(parent);</span>
<span class="fc" id="L117">    this.javaField = javaField;</span>
<span class="fc" id="L118">    this.annotation = annotation;</span>
<span class="fc" id="L119">    this.groupAs = groupAs;</span>
<span class="fc" id="L120">    this.collectionInfo = ObjectUtils.notNull(Lazy.lazy(() -&gt; IModelInstanceCollectionInfo.of(this)));</span>
<span class="fc" id="L121">    this.modelContainer = ObjectUtils.notNull(Lazy.lazy(() -&gt; new ChoiceGroupModelContainerSupport(</span>
<span class="fc" id="L122">        this.annotation.assemblies(),</span>
<span class="fc" id="L123">        this.annotation.fields(),</span>
        this)));
<span class="fc" id="L125">    this.classToInstanceMap = ObjectUtils.notNull(Lazy.lazy(() -&gt; Collections.unmodifiableMap(</span>
<span class="fc" id="L126">        getNamedModelInstances().stream()</span>
<span class="fc" id="L127">            .map(instance -&gt; instance)</span>
<span class="fc" id="L128">            .collect(Collectors.toMap(</span>
<span class="fc" id="L129">                item -&gt; item.getDefinition().getBoundClass(),</span>
<span class="fc" id="L130">                CustomCollectors.identity())))));</span>
<span class="fc" id="L131">    this.qnameToInstanceMap = ObjectUtils.notNull(Lazy.lazy(() -&gt; Collections.unmodifiableMap(</span>
<span class="fc" id="L132">        getNamedModelInstances().stream()</span>
<span class="fc" id="L133">            .collect(Collectors.toMap(</span>
                IBoundInstanceModelGroupedNamed::getXmlQName,
<span class="fc" id="L135">                CustomCollectors.identity())))));</span>
<span class="pc" id="L136">    this.discriminatorToInstanceMap = ObjectUtils.notNull(Lazy.lazy(() -&gt; Collections.unmodifiableMap(</span>
<span class="nc" id="L137">        getNamedModelInstances().stream()</span>
<span class="nc" id="L138">            .collect(Collectors.toMap(</span>
                IBoundInstanceModelGroupedNamed::getEffectiveDisciminatorValue,
<span class="nc" id="L140">                CustomCollectors.identity())))));</span>
<span class="fc" id="L141">  }</span>

  // ------------------------------------------
  // - Start annotation driven code - CPD-OFF -
  // ------------------------------------------

  @Override
  public Field getField() {
<span class="fc" id="L149">    return javaField;</span>
  }

  /**
   * Get the binding Java annotation.
   *
   * @return the binding Java annotation
   */
  @NonNull
  public BoundChoiceGroup getAnnotation() {
<span class="fc" id="L159">    return annotation;</span>
  }

  @SuppressWarnings(&quot;null&quot;)
  @Override
  public IModelInstanceCollectionInfo&lt;IBoundObject&gt; getCollectionInfo() {
<span class="fc" id="L165">    return collectionInfo.get();</span>
  }

  /**
   * Get the mapping of XML qualified names bound to a distinct grouped model
   * instance.
   *
   * @return the mapping
   */
  @SuppressWarnings(&quot;null&quot;)
  @NonNull
  protected Map&lt;QName, IBoundInstanceModelGroupedNamed&gt; getQNameToInstanceMap() {
<span class="fc" id="L177">    return qnameToInstanceMap.get();</span>
  }

  /**
   * Get the mapping of Java classes bound to a distinct grouped model instance.
   *
   * @return the mapping
   */
  @SuppressWarnings(&quot;null&quot;)
  @NonNull
  protected Map&lt;Class&lt;?&gt;, IBoundInstanceModelGroupedNamed&gt; getClassToInstanceMap() {
<span class="fc" id="L188">    return classToInstanceMap.get();</span>
  }

  /**
   * Get the mapping of JSON discriminator values bound to a distinct grouped
   * model instance.
   *
   * @return the mapping
   */
  @SuppressWarnings(&quot;null&quot;)
  @NonNull
  protected Map&lt;String, IBoundInstanceModelGroupedNamed&gt; getDiscriminatorToInstanceMap() {
<span class="nc" id="L200">    return discriminatorToInstanceMap.get();</span>
  }

  @Override
  @Nullable
  public IBoundInstanceModelGroupedNamed getGroupedModelInstance(@NonNull Class&lt;?&gt; clazz) {
<span class="fc" id="L206">    return getClassToInstanceMap().get(clazz);</span>
  }

  @Override
  @Nullable
  public IBoundInstanceModelGroupedNamed getGroupedModelInstance(@NonNull QName name) {
<span class="fc" id="L212">    return getQNameToInstanceMap().get(name);</span>
  }

  @Override
  public IBoundInstanceModelGroupedNamed getGroupedModelInstance(String discriminator) {
<span class="nc" id="L217">    return getDiscriminatorToInstanceMap().get(discriminator);</span>
  }

  @Override
  public IGroupAs getGroupAs() {
<span class="fc" id="L222">    return groupAs;</span>
  }

  @SuppressWarnings(&quot;null&quot;)
  @Override
  public ChoiceGroupModelContainerSupport getModelContainer() {
<span class="fc" id="L228">    return modelContainer.get();</span>
  }

  @Override
  public IBoundDefinitionModelAssembly getOwningDefinition() {
<span class="fc" id="L233">    return getParentContainer();</span>
  }

  @Override
  public IBoundModule getContainingModule() {
<span class="nc" id="L238">    return getOwningDefinition().getContainingModule();</span>
  }

  @Override
  public int getMinOccurs() {
<span class="nc" id="L243">    return getAnnotation().minOccurs();</span>
  }

  @Override
  public int getMaxOccurs() {
<span class="fc" id="L248">    return getAnnotation().maxOccurs();</span>
  }

  @Override
  public String getJsonDiscriminatorProperty() {
<span class="nc" id="L253">    return getAnnotation().discriminator();</span>
  }

  @Override
  public String getJsonKeyFlagInstanceName() {
<span class="nc" id="L258">    return getAnnotation().jsonKey();</span>
  }

  @Override
  public IBoundInstanceFlag getItemJsonKey(Object item) {
<span class="nc" id="L263">    String jsonKeyFlagName = getJsonKeyFlagInstanceName();</span>
<span class="nc" id="L264">    IBoundInstanceFlag retval = null;</span>

<span class="nc bnc" id="L266" title="All 2 branches missed.">    if (jsonKeyFlagName != null) {</span>
<span class="nc" id="L267">      Class&lt;?&gt; clazz = item.getClass();</span>

<span class="nc" id="L269">      IBoundInstanceModelGroupedNamed itemInstance = getClassToInstanceMap().get(clazz);</span>
<span class="nc" id="L270">      retval = itemInstance.getDefinition().getFlagInstanceByName(</span>
<span class="nc" id="L271">          new QName(itemInstance.getXmlNamespace(), jsonKeyFlagName));</span>
    }
<span class="nc" id="L273">    return retval;</span>
  }

<span class="fc" id="L276">  private static class ChoiceGroupModelContainerSupport</span>
      implements IContainerModelSupport&lt;
          IBoundInstanceModelGroupedNamed,
          IBoundInstanceModelGroupedNamed,
          IBoundInstanceModelGroupedField,
          IBoundInstanceModelGroupedAssembly&gt; {

    @NonNull
    private final Map&lt;QName, IBoundInstanceModelGroupedNamed&gt; namedModelInstances;
    @NonNull
    private final Map&lt;QName, IBoundInstanceModelGroupedField&gt; fieldInstances;
    @NonNull
    private final Map&lt;QName, IBoundInstanceModelGroupedAssembly&gt; assemblyInstances;

    public ChoiceGroupModelContainerSupport(
        @NonNull BoundGroupedAssembly[] assemblies,
        @NonNull BoundGroupedField[] fields,
<span class="fc" id="L293">        @NonNull IBoundInstanceModelChoiceGroup container) {</span>
<span class="fc" id="L294">      this.assemblyInstances = CollectionUtil.unmodifiableMap(ObjectUtils.notNull(Arrays.stream(assemblies)</span>
<span class="fc" id="L295">          .map(instance -&gt; {</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">            assert instance != null;</span>
<span class="fc" id="L297">            return IBoundInstanceModelGroupedAssembly.newInstance(instance,</span>
                container);
          })
<span class="fc" id="L300">          .collect(Collectors.toMap(</span>
              IBoundInstanceModelGroupedAssembly::getXmlQName,
<span class="fc" id="L302">              Function.identity(),</span>
<span class="fc" id="L303">              CustomCollectors.useLastMapper(),</span>
              LinkedHashMap::new))));
<span class="fc" id="L305">      this.fieldInstances = CollectionUtil.unmodifiableMap(ObjectUtils.notNull(Arrays.stream(fields)</span>
<span class="fc" id="L306">          .map(instance -&gt; {</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">            assert instance != null;</span>
<span class="nc" id="L308">            return IBoundInstanceModelGroupedField.newInstance(instance, container);</span>
          })
<span class="fc" id="L310">          .collect(Collectors.toMap(</span>
              IBoundInstanceModelGroupedField::getXmlQName,
<span class="fc" id="L312">              Function.identity(),</span>
<span class="fc" id="L313">              CustomCollectors.useLastMapper(),</span>
              LinkedHashMap::new))));
<span class="fc" id="L315">      this.namedModelInstances = CollectionUtil.unmodifiableMap(ObjectUtils.notNull(Stream.concat(</span>
<span class="fc" id="L316">          this.assemblyInstances.entrySet().stream(),</span>
<span class="fc" id="L317">          this.fieldInstances.entrySet().stream())</span>
<span class="fc" id="L318">          .collect(Collectors.toMap(</span>
              Entry::getKey,
              Entry::getValue,
<span class="fc" id="L321">              CustomCollectors.useLastMapper(),</span>
              LinkedHashMap::new))));
<span class="fc" id="L323">    }</span>

    @SuppressWarnings(&quot;null&quot;)
    @Override
    public Collection&lt;IBoundInstanceModelGroupedNamed&gt; getModelInstances() {
<span class="nc" id="L328">      return namedModelInstances.values();</span>
    }

    @Override
    public Map&lt;QName, IBoundInstanceModelGroupedNamed&gt; getNamedModelInstanceMap() {
<span class="fc" id="L333">      return namedModelInstances;</span>
    }

    @Override
    public Map&lt;QName, IBoundInstanceModelGroupedField&gt; getFieldInstanceMap() {
<span class="nc" id="L338">      return fieldInstances;</span>
    }

    @Override
    public Map&lt;QName, IBoundInstanceModelGroupedAssembly&gt; getAssemblyInstanceMap() {
<span class="nc" id="L343">      return assemblyInstances;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>