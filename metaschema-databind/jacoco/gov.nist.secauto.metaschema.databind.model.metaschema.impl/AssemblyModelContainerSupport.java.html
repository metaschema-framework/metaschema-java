<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AssemblyModelContainerSupport.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Metaschema Java Data Binding and Code Generation</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.metaschema.databind.model.metaschema.impl</a> &gt; <span class="el_source">AssemblyModelContainerSupport.java</span></div><h1>AssemblyModelContainerSupport.java</h1><pre class="source lang-java linenums">/*
 * SPDX-FileCopyrightText: none
 * SPDX-License-Identifier: CC0-1.0
 */

package gov.nist.secauto.metaschema.databind.model.metaschema.impl;

import gov.nist.secauto.metaschema.core.metapath.item.node.INodeItemFactory;
import gov.nist.secauto.metaschema.core.model.IAssemblyInstanceAbsolute;
import gov.nist.secauto.metaschema.core.model.IChoiceGroupInstance;
import gov.nist.secauto.metaschema.core.model.IChoiceInstance;
import gov.nist.secauto.metaschema.core.model.IContainerModelAssemblySupport;
import gov.nist.secauto.metaschema.core.model.IFieldInstanceAbsolute;
import gov.nist.secauto.metaschema.core.model.IModelInstanceAbsolute;
import gov.nist.secauto.metaschema.core.model.INamedModelInstanceAbsolute;
import gov.nist.secauto.metaschema.core.util.CollectionUtil;
import gov.nist.secauto.metaschema.core.util.ObjectUtils;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelAssembly;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelChoiceGroup;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelGroupedAssembly;
import gov.nist.secauto.metaschema.databind.model.metaschema.IBindingDefinitionModelAssembly;
import gov.nist.secauto.metaschema.databind.model.metaschema.binding.AssemblyModel;
import gov.nist.secauto.metaschema.databind.model.metaschema.binding.AssemblyReference;
import gov.nist.secauto.metaschema.databind.model.metaschema.binding.FieldReference;
import gov.nist.secauto.metaschema.databind.model.metaschema.binding.InlineDefineAssembly;
import gov.nist.secauto.metaschema.databind.model.metaschema.binding.InlineDefineField;
import gov.nist.secauto.metaschema.databind.model.metaschema.binding.AssemblyModel.Choice;
import gov.nist.secauto.metaschema.databind.model.metaschema.binding.AssemblyModel.ChoiceGroup;

import java.util.LinkedHashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.atomic.AtomicInteger;

import javax.xml.namespace.QName;

import edu.umd.cs.findbugs.annotations.NonNull;
import edu.umd.cs.findbugs.annotations.Nullable;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;

<span class="fc" id="L42">class AssemblyModelContainerSupport</span>
    extends AbstractBindingModelContainerSupport
    implements IContainerModelAssemblySupport&lt;
        IModelInstanceAbsolute,
        INamedModelInstanceAbsolute,
        IFieldInstanceAbsolute,
        IAssemblyInstanceAbsolute,
        IChoiceInstance,
        IChoiceGroupInstance&gt; {
  @NonNull
  private final List&lt;IModelInstanceAbsolute&gt; modelInstances;
  @NonNull
  private final Map&lt;QName, INamedModelInstanceAbsolute&gt; namedModelInstances;
  @NonNull
  private final Map&lt;QName, IFieldInstanceAbsolute&gt; fieldInstances;
  @NonNull
  private final Map&lt;QName, IAssemblyInstanceAbsolute&gt; assemblyInstances;
  @NonNull
  private final List&lt;IChoiceInstance&gt; choiceInstances;
  @NonNull
  private final Map&lt;String, IChoiceGroupInstance&gt; choiceGroupInstances;

  @SuppressWarnings(&quot;PMD.ShortMethodName&quot;)
  @SuppressFBWarnings(value = &quot;CT_CONSTRUCTOR_THROW&quot;, justification = &quot;Use of final fields&quot;)
  public static IContainerModelAssemblySupport&lt;
      IModelInstanceAbsolute,
      INamedModelInstanceAbsolute,
      IFieldInstanceAbsolute,
      IAssemblyInstanceAbsolute,
      IChoiceInstance,
      IChoiceGroupInstance&gt; of(
          @Nullable AssemblyModel binding,
          @NonNull IBoundInstanceModelAssembly bindingInstance,
          @NonNull IBindingDefinitionModelAssembly parent,
          @NonNull INodeItemFactory nodeItemFactory) {
    List&lt;Object&gt; instances;
<span class="pc bpc" id="L78" title="1 of 6 branches missed.">    return binding == null || (instances = binding.getInstances()) == null || instances.isEmpty()</span>
<span class="fc" id="L79">        ? IContainerModelAssemblySupport.empty()</span>
<span class="fc" id="L80">        : new AssemblyModelContainerSupport(</span>
            binding,
            bindingInstance,
            parent,
            nodeItemFactory);
  }

  /**
   * Construct a new assembly model container.
   *
   * @param model
   *          the assembly model object bound to a Java class
   * @param modelInstance
   *          the Metaschema module instance for the bound model object
   * @param parent
   *          the assembly definition containing this container
   * @param nodeItemFactory
   *          the node item factory used to generate child nodes
   */
  @SuppressWarnings({
      &quot;PMD.AvoidInstantiatingObjectsInLoops&quot;,
      &quot;PMD.UseConcurrentHashMap&quot;,
      &quot;PMD.PrematureDeclaration&quot;,
      &quot;PMD.NPathComplexity&quot; })
  @SuppressFBWarnings(value = &quot;CT_CONSTRUCTOR_THROW&quot;, justification = &quot;Use of final fields&quot;)
  protected AssemblyModelContainerSupport(
      @NonNull AssemblyModel model,
      @NonNull IBoundInstanceModelAssembly modelInstance,
      @NonNull IBindingDefinitionModelAssembly parent,
<span class="fc" id="L109">      @NonNull INodeItemFactory nodeItemFactory) {</span>

    // create temporary collections to store the child binding objects
<span class="fc" id="L112">    final List&lt;IModelInstanceAbsolute&gt; modelInstances = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L113">    final Map&lt;QName, INamedModelInstanceAbsolute&gt; namedModelInstances = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L114">    final Map&lt;QName, IFieldInstanceAbsolute&gt; fieldInstances = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L115">    final Map&lt;QName, IAssemblyInstanceAbsolute&gt; assemblyInstances = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L116">    final List&lt;IChoiceInstance&gt; choiceInstances = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L117">    final Map&lt;String, IChoiceGroupInstance&gt; choiceGroupInstances = new LinkedHashMap&lt;&gt;();</span>

    // create counters to track child positions
<span class="fc" id="L120">    AtomicInteger assemblyReferencePosition = new AtomicInteger();</span>
<span class="fc" id="L121">    AtomicInteger assemblyInlineDefinitionPosition = new AtomicInteger();</span>
<span class="fc" id="L122">    AtomicInteger fieldReferencePosition = new AtomicInteger();</span>
<span class="fc" id="L123">    AtomicInteger fieldInlineDefinitionPosition = new AtomicInteger();</span>
<span class="fc" id="L124">    AtomicInteger choicePosition = new AtomicInteger();</span>
<span class="fc" id="L125">    AtomicInteger choiceGroupPosition = new AtomicInteger();</span>

<span class="fc" id="L127">    IBoundInstanceModelChoiceGroup instance = ObjectUtils.requireNonNull(</span>
<span class="fc" id="L128">        modelInstance.getDefinition()</span>
<span class="fc" id="L129">            .getChoiceGroupInstanceByName(BindingConstants.METASCHEMA_CHOICE_GROUP_GROUP_AS_NAME));</span>
<span class="fc" id="L130">    ObjectUtils.notNull(model.getInstances()).forEach(obj -&gt; {</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">      assert obj != null;</span>

<span class="fc" id="L133">      IBoundInstanceModelGroupedAssembly objInstance</span>
<span class="fc" id="L134">          = (IBoundInstanceModelGroupedAssembly) instance.getItemInstance(obj);</span>

<span class="fc bfc" id="L136" title="All 2 branches covered.">      if (obj instanceof AssemblyReference) {</span>
<span class="fc" id="L137">        IAssemblyInstanceAbsolute assembly = newInstance(</span>
            (AssemblyReference) obj,
            objInstance,
<span class="fc" id="L140">            assemblyReferencePosition.getAndIncrement(),</span>
            parent);
<span class="fc" id="L142">        addInstance(assembly, modelInstances, namedModelInstances, assemblyInstances);</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">      } else if (obj instanceof InlineDefineAssembly) {</span>
<span class="fc" id="L144">        IAssemblyInstanceAbsolute assembly = new InstanceModelAssemblyInline(</span>
            (InlineDefineAssembly) obj,
            objInstance,
<span class="fc" id="L147">            assemblyInlineDefinitionPosition.getAndIncrement(),</span>
            parent,
            nodeItemFactory);
<span class="fc" id="L150">        addInstance(assembly, modelInstances, namedModelInstances, assemblyInstances);</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">      } else if (obj instanceof FieldReference) {</span>
<span class="fc" id="L152">        IFieldInstanceAbsolute field = newInstance(</span>
            (FieldReference) obj,
            objInstance,
<span class="fc" id="L155">            fieldReferencePosition.getAndIncrement(),</span>
            parent);
<span class="fc" id="L157">        addInstance(field, modelInstances, namedModelInstances, fieldInstances);</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">      } else if (obj instanceof InlineDefineField) {</span>
<span class="fc" id="L159">        IFieldInstanceAbsolute field = new InstanceModelFieldInline(</span>
            (InlineDefineField) obj,
            objInstance,
<span class="fc" id="L162">            fieldInlineDefinitionPosition.getAndIncrement(),</span>
            parent);
<span class="fc" id="L164">        addInstance(field, modelInstances, namedModelInstances, fieldInstances);</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">      } else if (obj instanceof AssemblyModel.Choice) {</span>
<span class="fc" id="L166">        IChoiceInstance choice = new InstanceModelChoice(</span>
            (Choice) obj,
            objInstance,
<span class="fc" id="L169">            choicePosition.getAndIncrement(),</span>
            parent,
            nodeItemFactory);
<span class="fc" id="L172">        addInstance(choice, modelInstances, choiceInstances);</span>
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">      } else if (obj instanceof AssemblyModel.ChoiceGroup) {</span>
<span class="fc" id="L174">        IChoiceGroupInstance choiceGroup = new InstanceModelChoiceGroup(</span>
            (ChoiceGroup) obj,
            objInstance,
<span class="fc" id="L177">            choiceGroupPosition.getAndIncrement(),</span>
            parent,
            nodeItemFactory);
<span class="fc" id="L180">        addInstance(choiceGroup, modelInstances, choiceGroupInstances);</span>
<span class="fc" id="L181">      } else {</span>
<span class="nc" id="L182">        throw new UnsupportedOperationException(String.format(&quot;Unknown model instance class: %s&quot;, obj.getClass()));</span>
      }
<span class="fc" id="L184">    });</span>

<span class="pc bpc" id="L186" title="1 of 2 branches missed.">    this.modelInstances = modelInstances.isEmpty()</span>
<span class="nc" id="L187">        ? CollectionUtil.emptyList()</span>
<span class="fc" id="L188">        : CollectionUtil.unmodifiableList(modelInstances);</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">    this.namedModelInstances = namedModelInstances.isEmpty()</span>
<span class="fc" id="L190">        ? CollectionUtil.emptyMap()</span>
<span class="fc" id="L191">        : CollectionUtil.unmodifiableMap(namedModelInstances);</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">    this.fieldInstances = fieldInstances.isEmpty()</span>
<span class="fc" id="L193">        ? CollectionUtil.emptyMap()</span>
<span class="fc" id="L194">        : CollectionUtil.unmodifiableMap(fieldInstances);</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">    this.assemblyInstances = assemblyInstances.isEmpty()</span>
<span class="fc" id="L196">        ? CollectionUtil.emptyMap()</span>
<span class="fc" id="L197">        : CollectionUtil.unmodifiableMap(assemblyInstances);</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">    this.choiceInstances = choiceInstances.isEmpty()</span>
<span class="fc" id="L199">        ? CollectionUtil.emptyList()</span>
<span class="fc" id="L200">        : CollectionUtil.unmodifiableList(choiceInstances);</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">    this.choiceGroupInstances = choiceGroupInstances.isEmpty()</span>
<span class="fc" id="L202">        ? CollectionUtil.emptyMap()</span>
<span class="fc" id="L203">        : CollectionUtil.unmodifiableMap(choiceGroupInstances);</span>
<span class="fc" id="L204">  }</span>

  @Override
  public List&lt;IModelInstanceAbsolute&gt; getModelInstances() {
<span class="fc" id="L208">    return modelInstances;</span>
  }

  @Override
  public Map&lt;QName, INamedModelInstanceAbsolute&gt; getNamedModelInstanceMap() {
<span class="nc" id="L213">    return namedModelInstances;</span>
  }

  @Override
  public Map&lt;QName, IFieldInstanceAbsolute&gt; getFieldInstanceMap() {
<span class="nc" id="L218">    return fieldInstances;</span>
  }

  @Override
  public Map&lt;QName, IAssemblyInstanceAbsolute&gt; getAssemblyInstanceMap() {
<span class="nc" id="L223">    return assemblyInstances;</span>
  }

  @Override
  public List&lt;IChoiceInstance&gt; getChoiceInstances() {
<span class="nc" id="L228">    return choiceInstances;</span>
  }

  @Override
  public Map&lt;String, IChoiceGroupInstance&gt; getChoiceGroupInstanceMap() {
<span class="nc" id="L233">    return choiceGroupInstances;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>