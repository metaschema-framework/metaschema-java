<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MetaschemaXmlWriter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Metaschema Java Data Binding and Code Generation</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.metaschema.databind.io.xml</a> &gt; <span class="el_source">MetaschemaXmlWriter.java</span></div><h1>MetaschemaXmlWriter.java</h1><pre class="source lang-java linenums">/*
 * SPDX-FileCopyrightText: none
 * SPDX-License-Identifier: CC0-1.0
 */

package gov.nist.secauto.metaschema.databind.io.xml;

import gov.nist.secauto.metaschema.core.model.IBoundObject;
import gov.nist.secauto.metaschema.core.util.ObjectUtils;
import gov.nist.secauto.metaschema.databind.io.json.DefaultJsonProblemHandler;
import gov.nist.secauto.metaschema.databind.model.IBoundDefinitionModel;
import gov.nist.secauto.metaschema.databind.model.IBoundDefinitionModelAssembly;
import gov.nist.secauto.metaschema.databind.model.IBoundDefinitionModelComplex;
import gov.nist.secauto.metaschema.databind.model.IBoundDefinitionModelFieldComplex;
import gov.nist.secauto.metaschema.databind.model.IBoundFieldValue;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceFlag;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModel;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelAssembly;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelChoiceGroup;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelFieldComplex;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelFieldScalar;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelGroupedAssembly;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelGroupedField;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelGroupedNamed;
import gov.nist.secauto.metaschema.databind.model.IBoundInstanceModelNamed;
import gov.nist.secauto.metaschema.databind.model.info.AbstractModelInstanceWriteHandler;
import gov.nist.secauto.metaschema.databind.model.info.IFeatureComplexItemValueHandler;
import gov.nist.secauto.metaschema.databind.model.info.IItemWriteHandler;
import gov.nist.secauto.metaschema.databind.model.info.IModelInstanceCollectionInfo;

import org.codehaus.stax2.XMLStreamWriter2;

import java.io.IOException;

import javax.xml.namespace.NamespaceContext;
import javax.xml.namespace.QName;
import javax.xml.stream.XMLStreamException;

import edu.umd.cs.findbugs.annotations.NonNull;

public class MetaschemaXmlWriter implements IXmlWritingContext {
  @NonNull
  private final XMLStreamWriter2 writer;

  /**
   * Construct a new Module-aware JSON writer.
   *
   * @param writer
   *          the XML stream writer to write with
   * @see DefaultJsonProblemHandler
   */
  public MetaschemaXmlWriter(
<span class="fc" id="L53">      @NonNull XMLStreamWriter2 writer) {</span>
<span class="fc" id="L54">    this.writer = writer;</span>
<span class="fc" id="L55">  }</span>

  @Override
  public XMLStreamWriter2 getWriter() {
<span class="nc" id="L59">    return writer;</span>
  }

  // =====================================
  // Entry point for top-level-definitions
  // =====================================

  @Override
  public void write(
      @NonNull IBoundDefinitionModelComplex definition,
      @NonNull IBoundObject item) throws IOException {

<span class="nc" id="L71">    QName qname = definition.getXmlQName();</span>

<span class="nc" id="L73">    definition.writeItem(item, new ItemWriter(qname));</span>
<span class="nc" id="L74">  }</span>

  @Override
  public void writeRoot(
      @NonNull IBoundDefinitionModelAssembly definition,
      @NonNull IBoundObject item) throws IOException {
<span class="fc" id="L80">    definition.writeItem(item, new ItemWriter(ObjectUtils.requireNonNull(definition.getRootXmlQName())));</span>
<span class="fc" id="L81">  }</span>

  // ================
  // Instance writers
  // ================

  private &lt;T&gt; void writeModelInstance(
      @NonNull IBoundInstanceModel&lt;T&gt; instance,
      @NonNull Object parentItem,
      @NonNull ItemWriter itemWriter) throws IOException {
<span class="fc" id="L91">    Object value = instance.getValue(parentItem);</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L93">      return;</span>
    }

    // this if is not strictly needed, since isEmpty will return false on a null
    // value
    // checking null here potentially avoids the expensive operation of
    // instantiating
<span class="fc" id="L100">    IModelInstanceCollectionInfo&lt;T&gt; collectionInfo = instance.getCollectionInfo();</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">    if (!collectionInfo.isEmpty(value)) {</span>
<span class="fc" id="L102">      QName currentQName = itemWriter.getObjectQName();</span>
<span class="fc" id="L103">      QName groupAsQName = instance.getEffectiveXmlGroupAsQName();</span>
      try {
<span class="fc bfc" id="L105" title="All 2 branches covered.">        if (groupAsQName != null) {</span>
          // write the grouping element
<span class="fc" id="L107">          writer.writeStartElement(groupAsQName.getNamespaceURI(), groupAsQName.getLocalPart());</span>
<span class="fc" id="L108">          currentQName = groupAsQName;</span>
        }

<span class="fc" id="L111">        collectionInfo.writeItems(</span>
            new ModelInstanceWriteHandler&lt;&gt;(instance, new ItemWriter(currentQName)),
            value);

<span class="fc bfc" id="L115" title="All 2 branches covered.">        if (groupAsQName != null) {</span>
<span class="fc" id="L116">          writer.writeEndElement();</span>
        }
<span class="nc" id="L118">      } catch (XMLStreamException ex) {</span>
<span class="nc" id="L119">        throw new IOException(ex);</span>
<span class="fc" id="L120">      }</span>
    }
<span class="fc" id="L122">  }</span>

  private static class ModelInstanceWriteHandler&lt;ITEM&gt;
      extends AbstractModelInstanceWriteHandler&lt;ITEM&gt; {
    @NonNull
    private final ItemWriter itemWriter;

    public ModelInstanceWriteHandler(
        @NonNull IBoundInstanceModel&lt;ITEM&gt; instance,
        @NonNull ItemWriter itemWriter) {
<span class="fc" id="L132">      super(instance);</span>
<span class="fc" id="L133">      this.itemWriter = itemWriter;</span>
<span class="fc" id="L134">    }</span>

    @Override
    public void writeItem(ITEM item) throws IOException {
<span class="fc" id="L138">      IBoundInstanceModel&lt;ITEM&gt; instance = getInstance();</span>
<span class="fc" id="L139">      instance.writeItem(item, itemWriter);</span>
<span class="fc" id="L140">    }</span>
  }

<span class="fc" id="L143">  private class ItemWriter</span>
      extends AbstractItemWriter {

<span class="fc" id="L146">    public ItemWriter(@NonNull QName qname) {</span>
<span class="fc" id="L147">      super(qname);</span>
<span class="fc" id="L148">    }</span>

    private &lt;T extends IBoundInstanceModelNamed&lt;IBoundObject&gt; &amp; IFeatureComplexItemValueHandler&gt; void writeFlags(
        @NonNull IBoundObject parentItem,
        @NonNull T instance) throws IOException {
<span class="fc" id="L153">      writeFlags(parentItem, instance.getDefinition());</span>
<span class="fc" id="L154">    }</span>

    private &lt;T extends IBoundInstanceModelGroupedNamed &amp; IFeatureComplexItemValueHandler&gt; void writeFlags(
        @NonNull IBoundObject parentItem,
        @NonNull T instance) throws IOException {
<span class="nc" id="L159">      writeFlags(parentItem, instance.getDefinition());</span>
<span class="nc" id="L160">    }</span>

    private void writeFlags(
        @NonNull IBoundObject parentItem,
        @NonNull IBoundDefinitionModel&lt;?&gt; definition) throws IOException {
<span class="fc bfc" id="L165" title="All 2 branches covered.">      for (IBoundInstanceFlag flag : definition.getFlagInstances()) {</span>
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">        assert flag != null;</span>

<span class="fc" id="L168">        Object value = flag.getValue(parentItem);</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        if (value != null) {</span>
<span class="fc" id="L170">          writeItemFlag(value, flag);</span>
        }
<span class="fc" id="L172">      }</span>
<span class="fc" id="L173">    }</span>

    private &lt;T extends IBoundInstanceModelAssembly &amp; IFeatureComplexItemValueHandler&gt; void writeAssemblyModel(
        @NonNull IBoundObject parentItem,
        @NonNull T instance) throws IOException {
<span class="fc" id="L178">      writeAssemblyModel(parentItem, instance.getDefinition());</span>
<span class="fc" id="L179">    }</span>

    private &lt;T extends IBoundInstanceModelGroupedAssembly &amp; IFeatureComplexItemValueHandler&gt; void writeAssemblyModel(
        @NonNull IBoundObject parentItem,
        @NonNull T instance) throws IOException {
<span class="nc" id="L184">      writeAssemblyModel(parentItem, instance.getDefinition());</span>
<span class="nc" id="L185">    }</span>

    private void writeAssemblyModel(
        @NonNull IBoundObject parentItem,
        @NonNull IBoundDefinitionModelAssembly definition) throws IOException {
<span class="fc bfc" id="L190" title="All 2 branches covered.">      for (IBoundInstanceModel&lt;?&gt; modelInstance : definition.getModelInstances()) {</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">        assert modelInstance != null;</span>
<span class="fc" id="L192">        writeModelInstance(modelInstance, parentItem, this);</span>
<span class="fc" id="L193">      }</span>
<span class="fc" id="L194">    }</span>

    private void writeFieldValue(
        @NonNull IBoundObject parentItem,
        @NonNull IBoundInstanceModelFieldComplex instance) throws IOException {
<span class="fc" id="L199">      writeFieldValue(parentItem, instance.getDefinition());</span>
<span class="fc" id="L200">    }</span>

    private void writeFieldValue(
        @NonNull IBoundObject parentItem,
        @NonNull IBoundInstanceModelGroupedField instance) throws IOException {
<span class="nc" id="L205">      writeFieldValue(parentItem, instance.getDefinition());</span>
<span class="nc" id="L206">    }</span>

    private void writeFieldValue(
        @NonNull IBoundObject parentItem,
        @NonNull IBoundDefinitionModelFieldComplex definition) throws IOException {
<span class="fc" id="L211">      definition.getFieldValue().writeItem(parentItem, this);</span>
<span class="fc" id="L212">    }</span>

    private &lt;T extends IFeatureComplexItemValueHandler &amp; IBoundInstanceModelNamed&lt;IBoundObject&gt;&gt; void writeModelObject(
        @NonNull T instance,
        @NonNull IBoundObject parentItem,
        @NonNull ObjectWriter&lt;T&gt; propertyWriter) throws IOException {
      try {
<span class="fc" id="L219">        QName wrapperQName = instance.getXmlQName();</span>
<span class="fc" id="L220">        writer.writeStartElement(wrapperQName.getNamespaceURI(), wrapperQName.getLocalPart());</span>

<span class="fc" id="L222">        propertyWriter.accept(parentItem, instance);</span>

<span class="fc" id="L224">        writer.writeEndElement();</span>
<span class="nc" id="L225">      } catch (XMLStreamException ex) {</span>
<span class="nc" id="L226">        throw new IOException(ex);</span>
<span class="fc" id="L227">      }</span>
<span class="fc" id="L228">    }</span>

    private &lt;T extends IFeatureComplexItemValueHandler &amp; IBoundInstanceModelGroupedNamed&gt; void writeGroupedModelObject(
        @NonNull T instance,
        @NonNull IBoundObject parentItem,
        @NonNull ObjectWriter&lt;T&gt; propertyWriter) throws IOException {
      try {
<span class="nc" id="L235">        QName wrapperQName = instance.getXmlQName();</span>
<span class="nc" id="L236">        writer.writeStartElement(wrapperQName.getNamespaceURI(), wrapperQName.getLocalPart());</span>

<span class="nc" id="L238">        propertyWriter.accept(parentItem, instance);</span>

<span class="nc" id="L240">        writer.writeEndElement();</span>
<span class="nc" id="L241">      } catch (XMLStreamException ex) {</span>
<span class="nc" id="L242">        throw new IOException(ex);</span>
<span class="nc" id="L243">      }</span>
<span class="nc" id="L244">    }</span>

    private &lt;T extends IFeatureComplexItemValueHandler &amp; IBoundDefinitionModelComplex&gt; void writeDefinitionObject(
        @NonNull T definition,
        @NonNull IBoundObject parentItem,
        @NonNull ObjectWriter&lt;T&gt; propertyWriter) throws IOException {

      try {
<span class="fc" id="L252">        QName qname = getObjectQName();</span>
<span class="fc" id="L253">        NamespaceContext nsContext = writer.getNamespaceContext();</span>
<span class="fc" id="L254">        String prefix = nsContext.getPrefix(qname.getNamespaceURI());</span>
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">        if (prefix == null) {</span>
<span class="fc" id="L256">          prefix = &quot;&quot;;</span>
        }

<span class="fc" id="L259">        writer.writeStartElement(prefix, qname.getLocalPart(), qname.getNamespaceURI());</span>

<span class="fc" id="L261">        propertyWriter.accept(parentItem, definition);</span>

<span class="fc" id="L263">        writer.writeEndElement();</span>
<span class="nc" id="L264">      } catch (XMLStreamException ex) {</span>
<span class="nc" id="L265">        throw new IOException(ex);</span>
<span class="fc" id="L266">      }</span>
<span class="fc" id="L267">    }</span>

    @Override
    public void writeItemFlag(Object item, IBoundInstanceFlag instance) throws IOException {
<span class="fc" id="L271">      String itemString = instance.getJavaTypeAdapter().asString(item);</span>
<span class="fc" id="L272">      QName name = instance.getXmlQName();</span>
      try {
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">        if (name.getNamespaceURI().isEmpty()) {</span>
<span class="fc" id="L275">          writer.writeAttribute(name.getLocalPart(), itemString);</span>
        } else {
<span class="nc" id="L277">          writer.writeAttribute(name.getNamespaceURI(), name.getLocalPart(), itemString);</span>
        }
<span class="nc" id="L279">      } catch (XMLStreamException ex) {</span>
<span class="nc" id="L280">        throw new IOException(ex);</span>
<span class="fc" id="L281">      }</span>
<span class="fc" id="L282">    }</span>

    @Override
    public void writeItemField(Object item, IBoundInstanceModelFieldScalar instance) throws IOException {
      try {
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">        if (instance.isEffectiveValueWrappedInXml()) {</span>
<span class="fc" id="L288">          QName wrapperQName = instance.getXmlQName();</span>
<span class="fc" id="L289">          writer.writeStartElement(wrapperQName.getNamespaceURI(), wrapperQName.getLocalPart());</span>
<span class="fc" id="L290">          instance.getJavaTypeAdapter().writeXmlValue(item, wrapperQName, writer);</span>
<span class="fc" id="L291">          writer.writeEndElement();</span>
<span class="fc" id="L292">        } else {</span>
<span class="nc" id="L293">          instance.getJavaTypeAdapter().writeXmlValue(item, getObjectQName(), writer);</span>
        }
<span class="nc" id="L295">      } catch (XMLStreamException ex) {</span>
<span class="nc" id="L296">        throw new IOException(ex);</span>
<span class="fc" id="L297">      }</span>
<span class="fc" id="L298">    }</span>

    @Override
    public void writeItemField(IBoundObject item, IBoundInstanceModelFieldComplex instance) throws IOException {
<span class="fc" id="L302">      ItemWriter itemWriter = new ItemWriter(instance.getXmlQName());</span>
<span class="fc" id="L303">      writeModelObject(</span>
          instance,
          item,
          ((ObjectWriter&lt;IBoundInstanceModelFieldComplex&gt;) this::writeFlags)
<span class="fc" id="L307">              .andThen(itemWriter::writeFieldValue));</span>
<span class="fc" id="L308">    }</span>

    @Override
    public void writeItemField(IBoundObject item, IBoundInstanceModelGroupedField instance) throws IOException {
<span class="nc" id="L312">      ItemWriter itemWriter = new ItemWriter(instance.getXmlQName());</span>
<span class="nc" id="L313">      writeGroupedModelObject(</span>
          instance,
          item,
          ((ObjectWriter&lt;IBoundInstanceModelGroupedField&gt;) this::writeFlags)
<span class="nc" id="L317">              .andThen(itemWriter::writeFieldValue));</span>
<span class="nc" id="L318">    }</span>

    @Override
    public void writeItemField(IBoundObject item, IBoundDefinitionModelFieldComplex definition) throws IOException {
<span class="nc" id="L322">      ItemWriter itemWriter = new ItemWriter(definition.getXmlQName());</span>
<span class="nc" id="L323">      writeDefinitionObject(</span>
          definition,
          item,
          ((ObjectWriter&lt;IBoundDefinitionModelFieldComplex&gt;) this::writeFlags)
<span class="nc" id="L327">              .andThen(itemWriter::writeFieldValue));</span>
<span class="nc" id="L328">    }</span>

    @Override
    public void writeItemFieldValue(Object parentItem, IBoundFieldValue fieldValue) throws IOException {
<span class="fc" id="L332">      Object item = fieldValue.getValue(parentItem);</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">      if (item != null) {</span>
        try {
<span class="fc" id="L335">          fieldValue.getJavaTypeAdapter().writeXmlValue(item, getObjectQName(), writer);</span>
<span class="nc" id="L336">        } catch (XMLStreamException ex) {</span>
<span class="nc" id="L337">          throw new IOException(ex);</span>
<span class="fc" id="L338">        }</span>
      }
<span class="fc" id="L340">    }</span>

    @Override
    public void writeItemAssembly(IBoundObject item, IBoundInstanceModelAssembly instance) throws IOException {
<span class="fc" id="L344">      ItemWriter itemWriter = new ItemWriter(instance.getXmlQName());</span>
<span class="fc" id="L345">      writeModelObject(</span>
          instance,
          item,
          ((ObjectWriter&lt;IBoundInstanceModelAssembly&gt;) this::writeFlags)
<span class="fc" id="L349">              .andThen(itemWriter::writeAssemblyModel));</span>
<span class="fc" id="L350">    }</span>

    @Override
    public void writeItemAssembly(IBoundObject item, IBoundInstanceModelGroupedAssembly instance) throws IOException {
<span class="nc" id="L354">      ItemWriter itemWriter = new ItemWriter(instance.getXmlQName());</span>
<span class="nc" id="L355">      writeGroupedModelObject(</span>
          instance,
          item,
          ((ObjectWriter&lt;IBoundInstanceModelGroupedAssembly&gt;) this::writeFlags)
<span class="nc" id="L359">              .andThen(itemWriter::writeAssemblyModel));</span>
<span class="nc" id="L360">    }</span>

    @Override
    public void writeItemAssembly(IBoundObject item, IBoundDefinitionModelAssembly definition) throws IOException {
      // this is a special case where we are writing a top-level, potentially root,
      // element. Need to take the object qname passed in
<span class="fc" id="L366">      writeDefinitionObject(</span>
          definition,
          item,
          ((ObjectWriter&lt;IBoundDefinitionModelAssembly&gt;) this::writeFlags)
<span class="fc" id="L370">              .andThen(this::writeAssemblyModel));</span>
<span class="fc" id="L371">    }</span>

    @Override
    public void writeChoiceGroupItem(IBoundObject item, IBoundInstanceModelChoiceGroup instance) throws IOException {
<span class="nc" id="L375">      IBoundInstanceModelGroupedNamed actualInstance = instance.getItemInstance(item);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">      assert actualInstance != null;</span>
<span class="nc" id="L377">      actualInstance.writeItem(item, this);</span>
<span class="nc" id="L378">    }</span>
  }

  private abstract static class AbstractItemWriter implements IItemWriteHandler {
    @NonNull
    private final QName objectQName;

<span class="fc" id="L385">    protected AbstractItemWriter(@NonNull QName qname) {</span>
<span class="fc" id="L386">      this.objectQName = qname;</span>
<span class="fc" id="L387">    }</span>

    /**
     * Get the qualified name of the item's parent.
     *
     * @return the qualified name
     */
    @NonNull
    protected QName getObjectQName() {
<span class="fc" id="L396">      return objectQName;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>