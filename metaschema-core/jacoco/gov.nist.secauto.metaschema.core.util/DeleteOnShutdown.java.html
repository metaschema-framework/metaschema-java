<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeleteOnShutdown.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Metaschema Core API</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.metaschema.core.util</a> &gt; <span class="el_source">DeleteOnShutdown.java</span></div><h1>DeleteOnShutdown.java</h1><pre class="source lang-java linenums">/*
 * SPDX-FileCopyrightText: none
 * SPDX-License-Identifier: CC0-1.0
 */

package gov.nist.secauto.metaschema.core.util;

import java.io.IOException;
import java.nio.file.FileVisitResult;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.SimpleFileVisitor;
import java.nio.file.attribute.BasicFileAttributes;
import java.util.LinkedHashSet;
import java.util.Set;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

/**
 * Used to perform cleanup on shutdown.
 */
@SuppressWarnings(&quot;PMD.DoNotUseThreads&quot;)
public final class DeleteOnShutdown {
<span class="nc" id="L24">  private static Set&lt;Path&gt; paths = new LinkedHashSet&lt;&gt;();</span>
<span class="nc" id="L25">  private static final Lock LOCK = new ReentrantLock();</span>

  static {
<span class="nc" id="L28">    Runtime.getRuntime().addShutdownHook(</span>
        new Thread(DeleteOnShutdown::shutdownHook));
<span class="nc" id="L30">  }</span>

  @SuppressWarnings(&quot;PMD.NullAssignment&quot;)
  private static void shutdownHook() {
<span class="nc" id="L34">    LOCK.lock();</span>
    try {
<span class="nc" id="L36">      Set&lt;Path&gt; localSet = new LinkedHashSet&lt;&gt;(paths);</span>
<span class="nc" id="L37">      paths = null;</span>
<span class="nc" id="L38">      localSet.forEach(path -&gt; {</span>
        try {
<span class="nc" id="L40">          Files.walkFileTree(path,</span>
<span class="nc" id="L41">              new SimpleFileVisitor&lt;&gt;() {</span>
                @Override
                public FileVisitResult postVisitDirectory(
                    Path dir, IOException exc) throws IOException {
<span class="nc" id="L45">                  Files.delete(dir);</span>
<span class="nc" id="L46">                  return FileVisitResult.CONTINUE;</span>
                }

                @Override
                public FileVisitResult visitFile(
                    Path file, BasicFileAttributes attrs)
                    throws IOException {
<span class="nc" id="L53">                  Files.delete(file);</span>
<span class="nc" id="L54">                  return FileVisitResult.CONTINUE;</span>
                }
              });
<span class="nc" id="L57">        } catch (IOException ex) {</span>
          // this is a best effort
<span class="nc" id="L59">        }</span>
<span class="nc" id="L60">      });</span>
    } finally {
<span class="nc" id="L62">      LOCK.unlock();</span>
    }
<span class="nc" id="L64">  }</span>

  /**
   * Register a new path to be deleted on JVM termination.
   * &lt;p&gt;
   * If the path is a directory, then its contents will also be deleted.
   *
   * @param path
   *          the path to delete
   */
  public static void register(Path path) {
<span class="nc" id="L75">    LOCK.lock();</span>
    try {
<span class="nc bnc" id="L77" title="All 2 branches missed.">      if (paths == null) {</span>
<span class="nc" id="L78">        throw new IllegalStateException(&quot;ShutdownHook already in progress.&quot;);</span>
      }
<span class="nc" id="L80">      paths.add(path);</span>
    } finally {
<span class="nc" id="L82">      LOCK.unlock();</span>
    }
<span class="nc" id="L84">  }</span>

  private DeleteOnShutdown() {
    // disable construction
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>