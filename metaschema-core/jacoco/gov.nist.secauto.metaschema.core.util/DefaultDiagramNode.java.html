<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultDiagramNode.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Metaschema Core API</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.metaschema.core.util</a> &gt; <span class="el_source">DefaultDiagramNode.java</span></div><h1>DefaultDiagramNode.java</h1><pre class="source lang-java linenums">/*
 * SPDX-FileCopyrightText: none
 * SPDX-License-Identifier: CC0-1.0
 */

package gov.nist.secauto.metaschema.core.util;

import gov.nist.secauto.metaschema.core.datatype.IDataTypeAdapter;
import gov.nist.secauto.metaschema.core.model.IAssemblyDefinition;
import gov.nist.secauto.metaschema.core.model.IChoiceGroupInstance;
import gov.nist.secauto.metaschema.core.model.IChoiceInstance;
import gov.nist.secauto.metaschema.core.model.IModelDefinition;
import gov.nist.secauto.metaschema.core.model.IModelInstance;
import gov.nist.secauto.metaschema.core.model.INamedInstance;
import gov.nist.secauto.metaschema.core.model.INamedModelInstance;
import gov.nist.secauto.metaschema.core.model.INamedModelInstanceAbsolute;
import gov.nist.secauto.metaschema.core.model.INamedModelInstanceGrouped;

import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import edu.umd.cs.findbugs.annotations.NonNull;
import nl.talsmasoftware.lazy4j.Lazy;

/**
 * A basic implementation of a {@link IDiagramNodeVisitor}.
 */
@SuppressWarnings(&quot;PMD.DataClass&quot;)
public class DefaultDiagramNode implements IDiagramNode {
  @NonNull
  private final IModelDefinition definition;
  @NonNull
  private final String name;
  @NonNull
  private final List&lt;IDiagramNode.IAttribute&gt; attributes;
  @NonNull
  private final Lazy&lt;List&lt;IDiagramNode.IEdge&gt;&gt; edges;

  @NonNull
  private static String getParentContext(@NonNull IModelDefinition definition) {
    String retval;
<span class="fc bfc" id="L43" title="All 2 branches covered.">    if (definition.isInline()) {</span>
<span class="fc" id="L44">      INamedInstance instance = definition.getInlineInstance();</span>
<span class="fc" id="L45">      String name = instance.getEffectiveName();</span>
<span class="fc" id="L46">      retval = getParentContext(instance.getContainingDefinition()) + &quot;_&quot; + name;</span>
<span class="fc" id="L47">    } else {</span>
<span class="fc" id="L48">      retval = definition.getName();</span>
    }
<span class="fc" id="L50">    return retval;</span>
  }

  /**
   * Construct a new diagram node.
   *
   * @param definition
   *          the definition to base the node on
   */
  public DefaultDiagramNode(
<span class="fc" id="L60">      @NonNull IModelDefinition definition) {</span>
<span class="fc" id="L61">    this.definition = definition;</span>
<span class="fc" id="L62">    this.name = getParentContext(definition);</span>
<span class="fc" id="L63">    this.attributes = ObjectUtils.notNull(Stream.concat(</span>
<span class="fc" id="L64">        definition.getFlagInstances().stream()</span>
            // all flags
<span class="fc" id="L66">            .map((flag) -&gt; new Attribute(flag.getEffectiveName(), flag.getDefinition().getJavaTypeAdapter())),</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">        definition instanceof IAssemblyDefinition</span>
<span class="fc" id="L68">            ? ((IAssemblyDefinition) definition).getFieldInstances().stream()</span>
                // singleton fields with no flags
<span class="fc bfc" id="L70" title="All 2 branches covered.">                .filter(field -&gt; !INamedModelInstance.complexObjectFilter(field))</span>
<span class="fc" id="L71">                .map(field -&gt; new Attribute(field.getEffectiveName(), field.getDefinition().getJavaTypeAdapter()))</span>
<span class="fc" id="L72">            : Stream.empty())</span>
<span class="fc" id="L73">        .collect(Collectors.toUnmodifiableList()));</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">    this.edges = ObjectUtils.notNull(Lazy.lazy(() -&gt; definition instanceof IAssemblyDefinition</span>
<span class="fc" id="L75">        ? generateEdges((IAssemblyDefinition) definition)</span>
<span class="fc" id="L76">        : CollectionUtil.emptyList()));</span>
<span class="fc" id="L77">  }</span>

  @NonNull
  private List&lt;IDiagramNode.IEdge&gt; generateEdges(
      @NonNull IAssemblyDefinition definition) {
<span class="fc" id="L82">    return ObjectUtils.notNull(definition.getModelInstances().stream()</span>
<span class="fc" id="L83">        .flatMap(instance -&gt; {</span>
          Stream&lt;AbstractEdge&lt;?&gt;&gt; retval;
<span class="fc bfc" id="L85" title="All 2 branches covered.">          if (instance instanceof IChoiceInstance) {</span>
<span class="fc" id="L86">            IChoiceInstance choice = (IChoiceInstance) instance;</span>
<span class="fc" id="L87">            retval = choice.getNamedModelInstances().stream()</span>
<span class="fc" id="L88">                .filter(INamedModelInstance::complexObjectFilter)</span>
<span class="fc" id="L89">                .map(ci -&gt; new ChoiceEdge(choice, ObjectUtils.requireNonNull(ci)));</span>
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">          } else if (instance instanceof IChoiceGroupInstance) {</span>
<span class="nc" id="L91">            IChoiceGroupInstance choiceGroup = (IChoiceGroupInstance) instance;</span>
<span class="nc" id="L92">            retval = choiceGroup.getNamedModelInstances().stream()</span>
<span class="nc" id="L93">                .filter(INamedModelInstance::complexObjectFilter)</span>
<span class="nc" id="L94">                .map(cgi -&gt; new ChoiceGroupEdge(choiceGroup, ObjectUtils.requireNonNull(cgi)));</span>
<span class="nc" id="L95">          } else {</span>
<span class="fc" id="L96">            INamedModelInstanceAbsolute modelInstance = (INamedModelInstanceAbsolute) instance;</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">            retval = INamedModelInstance.complexObjectFilter(modelInstance)</span>
<span class="fc" id="L98">                ? Stream.of(new ModelEdge(ObjectUtils.requireNonNull(modelInstance)))</span>
<span class="fc" id="L99">                : Stream.empty();</span>
          }
<span class="fc" id="L101">          return retval;</span>
        })
<span class="fc" id="L103">        .collect(Collectors.toUnmodifiableList()));</span>
  }

  @Override
  @NonNull
  public IModelDefinition getDefinition() {
<span class="fc" id="L109">    return definition;</span>
  }

  @Override
  @NonNull
  public String getIdentifier() {
<span class="fc" id="L115">    return name;</span>
  }

  @Override
  public List&lt;IAttribute&gt; getAttributes() {
<span class="fc" id="L120">    return attributes;</span>
  }

  @Override
  public List&lt;IEdge&gt; getEdges() {
<span class="fc" id="L125">    return ObjectUtils.notNull(edges.get());</span>
  }

  private final class Attribute implements IDiagramNode.IAttribute {
    @NonNull
    private final String name;
    @NonNull
    private final IDataTypeAdapter&lt;?&gt; dataType;

<span class="fc" id="L134">    private Attribute(@NonNull String name, @NonNull IDataTypeAdapter&lt;?&gt; dataType) {</span>
<span class="fc" id="L135">      this.name = name;</span>
<span class="fc" id="L136">      this.dataType = dataType;</span>
<span class="fc" id="L137">    }</span>

    @Override
    public IDiagramNode getNode() {
<span class="nc" id="L141">      return DefaultDiagramNode.this;</span>
    }

    @Override
    @NonNull
    public String getLabel() {
<span class="fc" id="L147">      return name;</span>
    }

    @Override
    @NonNull
    public IDataTypeAdapter&lt;?&gt; getDataType() {
<span class="fc" id="L153">      return dataType;</span>
    }
  }

  private abstract class AbstractEdge&lt;T extends IModelInstance&gt; implements IDiagramNode.IEdge {
    @NonNull
    private final Relationship relationship;
    @NonNull
    private final T instance;

    protected AbstractEdge(
        @NonNull Relationship relationship,
<span class="fc" id="L165">        @NonNull T instance) {</span>
<span class="fc" id="L166">      this.relationship = relationship;</span>
<span class="fc" id="L167">      this.instance = instance;</span>
<span class="fc" id="L168">    }</span>

    @Override
    public IDiagramNode getNode() {
<span class="fc" id="L172">      return DefaultDiagramNode.this;</span>
    }

    @Override
    @NonNull
    public Relationship getRelationship() {
<span class="fc" id="L178">      return relationship;</span>
    }

    @Override
    @NonNull
    public T getInstance() {
<span class="fc" id="L184">      return instance;</span>
    }
  }

  public final class ModelEdge
      extends AbstractEdge&lt;INamedModelInstanceAbsolute&gt; {
    private ModelEdge(
<span class="fc" id="L191">        @NonNull INamedModelInstanceAbsolute instance) {</span>
<span class="fc" id="L192">      super(Relationship.toRelationship(instance), instance);</span>
<span class="fc" id="L193">    }</span>

    @Override
    public void accept(IDiagramNodeVisitor visitor) {
<span class="fc" id="L197">      visitor.visit(this);</span>
<span class="fc" id="L198">    }</span>
  }

  public final class ChoiceEdge
      extends AbstractEdge&lt;INamedModelInstanceAbsolute&gt; {
    @NonNull
    private final IChoiceInstance choice;

    private ChoiceEdge(
        @NonNull IChoiceInstance choice,
<span class="fc" id="L208">        @NonNull INamedModelInstanceAbsolute instance) {</span>
<span class="fc" id="L209">      super(Relationship.toRelationship(instance), instance);</span>
<span class="fc" id="L210">      this.choice = choice;</span>
<span class="fc" id="L211">    }</span>

    /**
     * Get the associated choice.
     *
     * @return the choice instance
     */
    @NonNull
    public IChoiceInstance getChoice() {
<span class="nc" id="L220">      return choice;</span>
    }

    @Override
    public void accept(IDiagramNodeVisitor visitor) {
<span class="fc" id="L225">      visitor.visit(this);</span>
<span class="fc" id="L226">    }</span>
  }

  public final class ChoiceGroupEdge
      extends AbstractEdge&lt;INamedModelInstanceGrouped&gt; {
    @NonNull
    private final IChoiceGroupInstance choiceGroup;

    private ChoiceGroupEdge(
        @NonNull IChoiceGroupInstance choiceGroup,
<span class="nc" id="L236">        @NonNull INamedModelInstanceGrouped instance) {</span>
<span class="nc" id="L237">      super(Relationship.toRelationship(choiceGroup), instance);</span>
<span class="nc" id="L238">      this.choiceGroup = choiceGroup;</span>
<span class="nc" id="L239">    }</span>

    /**
     * Get the associated choice group.
     *
     * @return the choice group instance
     */
    @NonNull
    public IChoiceGroupInstance getChoiceGroup() {
<span class="nc" id="L248">      return choiceGroup;</span>
    }

    @Override
    public void accept(IDiagramNodeVisitor visitor) {
<span class="nc" id="L253">      visitor.visit(this);</span>
<span class="nc" id="L254">    }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>