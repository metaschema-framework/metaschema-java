<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultDiagramNode.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Metaschema Core API</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.metaschema.core.model.util</a> &gt; <span class="el_source">DefaultDiagramNode.java</span></div><h1>DefaultDiagramNode.java</h1><pre class="source lang-java linenums">/*
 * SPDX-FileCopyrightText: none
 * SPDX-License-Identifier: CC0-1.0
 */

package gov.nist.secauto.metaschema.core.model.util;

import gov.nist.secauto.metaschema.core.datatype.IDataTypeAdapter;
import gov.nist.secauto.metaschema.core.model.IAssemblyDefinition;
import gov.nist.secauto.metaschema.core.model.IChoiceGroupInstance;
import gov.nist.secauto.metaschema.core.model.IChoiceInstance;
import gov.nist.secauto.metaschema.core.model.IModelDefinition;
import gov.nist.secauto.metaschema.core.model.IModelInstance;
import gov.nist.secauto.metaschema.core.model.INamedInstance;
import gov.nist.secauto.metaschema.core.model.INamedModelInstance;
import gov.nist.secauto.metaschema.core.model.INamedModelInstanceAbsolute;
import gov.nist.secauto.metaschema.core.model.INamedModelInstanceGrouped;
import gov.nist.secauto.metaschema.core.util.CollectionUtil;
import gov.nist.secauto.metaschema.core.util.ObjectUtils;

import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import edu.umd.cs.findbugs.annotations.NonNull;
import nl.talsmasoftware.lazy4j.Lazy;

/**
 * A basic implementation of a {@link IDiagramNodeVisitor}.
 */
@SuppressWarnings(&quot;PMD.DataClass&quot;)
public class DefaultDiagramNode implements IDiagramNode {
  @NonNull
  private final IModelDefinition definition;
  @NonNull
  private final String name;
  @NonNull
  private final List&lt;IDiagramNode.IAttribute&gt; attributes;
  @NonNull
  private final Lazy&lt;List&lt;IDiagramNode.IEdge&gt;&gt; edges;

  @NonNull
  private static String getParentContext(@NonNull IModelDefinition definition) {
    String retval;
<span class="fc bfc" id="L45" title="All 2 branches covered.">    if (definition.isInline()) {</span>
<span class="fc" id="L46">      INamedInstance instance = definition.getInlineInstance();</span>
<span class="fc" id="L47">      String name = instance.getEffectiveName();</span>
<span class="fc" id="L48">      retval = getParentContext(instance.getContainingDefinition()) + &quot;_&quot; + name;</span>
<span class="fc" id="L49">    } else {</span>
<span class="fc" id="L50">      retval = definition.getName();</span>
    }
<span class="fc" id="L52">    return retval;</span>
  }

  /**
   * Construct a new diagram node.
   *
   * @param definition
   *          the definition to base the node on
   */
  public DefaultDiagramNode(
<span class="fc" id="L62">      @NonNull IModelDefinition definition) {</span>
<span class="fc" id="L63">    this.definition = definition;</span>
<span class="fc" id="L64">    this.name = getParentContext(definition);</span>
<span class="fc" id="L65">    this.attributes = ObjectUtils.notNull(Stream.concat(</span>
<span class="fc" id="L66">        definition.getFlagInstances().stream()</span>
            // all flags
<span class="fc" id="L68">            .map(flag -&gt; new Attribute(flag.getEffectiveName(), flag.getDefinition().getJavaTypeAdapter())),</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">        definition instanceof IAssemblyDefinition</span>
<span class="fc" id="L70">            ? ((IAssemblyDefinition) definition).getFieldInstances().stream()</span>
                // singleton fields with no flags
<span class="fc bfc" id="L72" title="All 2 branches covered.">                .filter(field -&gt; !INamedModelInstance.complexObjectFilter(field))</span>
<span class="fc" id="L73">                .map(field -&gt; new Attribute(field.getEffectiveName(), field.getDefinition().getJavaTypeAdapter()))</span>
<span class="fc" id="L74">            : Stream.empty())</span>
<span class="fc" id="L75">        .collect(Collectors.toUnmodifiableList()));</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">    this.edges = ObjectUtils.notNull(Lazy.lazy(() -&gt; definition instanceof IAssemblyDefinition</span>
<span class="fc" id="L77">        ? generateEdges((IAssemblyDefinition) definition)</span>
<span class="fc" id="L78">        : CollectionUtil.emptyList()));</span>
<span class="fc" id="L79">  }</span>

  @NonNull
  private List&lt;IDiagramNode.IEdge&gt; generateEdges(
      @NonNull IAssemblyDefinition definition) {
<span class="fc" id="L84">    return ObjectUtils.notNull(definition.getModelInstances().stream()</span>
<span class="fc" id="L85">        .flatMap(instance -&gt; {</span>
          Stream&lt;AbstractEdge&lt;?&gt;&gt; retval;
<span class="fc bfc" id="L87" title="All 2 branches covered.">          if (instance instanceof IChoiceInstance) {</span>
<span class="fc" id="L88">            IChoiceInstance choice = (IChoiceInstance) instance;</span>
<span class="fc" id="L89">            retval = choice.getNamedModelInstances().stream()</span>
<span class="fc" id="L90">                .filter(INamedModelInstance::complexObjectFilter)</span>
<span class="fc" id="L91">                .map(ci -&gt; new ChoiceEdge(choice, ObjectUtils.requireNonNull(ci)));</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">          } else if (instance instanceof IChoiceGroupInstance) {</span>
<span class="nc" id="L93">            IChoiceGroupInstance choiceGroup = (IChoiceGroupInstance) instance;</span>
<span class="nc" id="L94">            retval = choiceGroup.getNamedModelInstances().stream()</span>
<span class="nc" id="L95">                .filter(INamedModelInstance::complexObjectFilter)</span>
<span class="nc" id="L96">                .map(cgi -&gt; new ChoiceGroupEdge(choiceGroup, ObjectUtils.requireNonNull(cgi)));</span>
<span class="nc" id="L97">          } else {</span>
<span class="fc" id="L98">            INamedModelInstanceAbsolute modelInstance = (INamedModelInstanceAbsolute) instance;</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">            retval = INamedModelInstance.complexObjectFilter(modelInstance)</span>
<span class="fc" id="L100">                ? Stream.of(new ModelEdge(ObjectUtils.requireNonNull(modelInstance)))</span>
<span class="fc" id="L101">                : Stream.empty();</span>
          }
<span class="fc" id="L103">          return retval;</span>
        })
<span class="fc" id="L105">        .collect(Collectors.toUnmodifiableList()));</span>
  }

  @Override
  @NonNull
  public IModelDefinition getDefinition() {
<span class="fc" id="L111">    return definition;</span>
  }

  @Override
  @NonNull
  public String getIdentifier() {
<span class="fc" id="L117">    return name;</span>
  }

  @Override
  public List&lt;IAttribute&gt; getAttributes() {
<span class="fc" id="L122">    return attributes;</span>
  }

  @Override
  public List&lt;IEdge&gt; getEdges() {
<span class="fc" id="L127">    return ObjectUtils.notNull(edges.get());</span>
  }

  private final class Attribute implements IDiagramNode.IAttribute {
    @NonNull
    private final String name;
    @NonNull
    private final IDataTypeAdapter&lt;?&gt; dataType;

<span class="fc" id="L136">    private Attribute(@NonNull String name, @NonNull IDataTypeAdapter&lt;?&gt; dataType) {</span>
<span class="fc" id="L137">      this.name = name;</span>
<span class="fc" id="L138">      this.dataType = dataType;</span>
<span class="fc" id="L139">    }</span>

    @Override
    public IDiagramNode getNode() {
<span class="nc" id="L143">      return DefaultDiagramNode.this;</span>
    }

    @Override
    @NonNull
    public String getLabel() {
<span class="fc" id="L149">      return name;</span>
    }

    @Override
    @NonNull
    public IDataTypeAdapter&lt;?&gt; getDataType() {
<span class="fc" id="L155">      return dataType;</span>
    }
  }

  private abstract class AbstractEdge&lt;T extends IModelInstance&gt; implements IDiagramNode.IEdge {
    @NonNull
    private final Relationship relationship;
    @NonNull
    private final T instance;

    protected AbstractEdge(
        @NonNull Relationship relationship,
<span class="fc" id="L167">        @NonNull T instance) {</span>
<span class="fc" id="L168">      this.relationship = relationship;</span>
<span class="fc" id="L169">      this.instance = instance;</span>
<span class="fc" id="L170">    }</span>

    @Override
    public IDiagramNode getNode() {
<span class="fc" id="L174">      return DefaultDiagramNode.this;</span>
    }

    @Override
    @NonNull
    public Relationship getRelationship() {
<span class="fc" id="L180">      return relationship;</span>
    }

    @Override
    @NonNull
    public T getInstance() {
<span class="fc" id="L186">      return instance;</span>
    }
  }

  public final class ModelEdge
      extends AbstractEdge&lt;INamedModelInstanceAbsolute&gt; {
    private ModelEdge(
<span class="fc" id="L193">        @NonNull INamedModelInstanceAbsolute instance) {</span>
<span class="fc" id="L194">      super(Relationship.toRelationship(instance), instance);</span>
<span class="fc" id="L195">    }</span>

    @Override
    public void accept(IDiagramNodeVisitor visitor) {
<span class="fc" id="L199">      visitor.visit(this);</span>
<span class="fc" id="L200">    }</span>
  }

  public final class ChoiceEdge
      extends AbstractEdge&lt;INamedModelInstanceAbsolute&gt; {
    @NonNull
    private final IChoiceInstance choice;

    private ChoiceEdge(
        @NonNull IChoiceInstance choice,
<span class="fc" id="L210">        @NonNull INamedModelInstanceAbsolute instance) {</span>
<span class="fc" id="L211">      super(Relationship.toRelationship(instance), instance);</span>
<span class="fc" id="L212">      this.choice = choice;</span>
<span class="fc" id="L213">    }</span>

    /**
     * Get the associated choice.
     *
     * @return the choice instance
     */
    @NonNull
    public IChoiceInstance getChoice() {
<span class="nc" id="L222">      return choice;</span>
    }

    @Override
    public void accept(IDiagramNodeVisitor visitor) {
<span class="fc" id="L227">      visitor.visit(this);</span>
<span class="fc" id="L228">    }</span>
  }

  public final class ChoiceGroupEdge
      extends AbstractEdge&lt;INamedModelInstanceGrouped&gt; {
    @NonNull
    private final IChoiceGroupInstance choiceGroup;

    private ChoiceGroupEdge(
        @NonNull IChoiceGroupInstance choiceGroup,
<span class="nc" id="L238">        @NonNull INamedModelInstanceGrouped instance) {</span>
<span class="nc" id="L239">      super(Relationship.toRelationship(choiceGroup), instance);</span>
<span class="nc" id="L240">      this.choiceGroup = choiceGroup;</span>
<span class="nc" id="L241">    }</span>

    /**
     * Get the associated choice group.
     *
     * @return the choice group instance
     */
    @NonNull
    public IChoiceGroupInstance getChoiceGroup() {
<span class="nc" id="L250">      return choiceGroup;</span>
    }

    @Override
    public void accept(IDiagramNodeVisitor visitor) {
<span class="nc" id="L255">      visitor.visit(this);</span>
<span class="nc" id="L256">    }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>