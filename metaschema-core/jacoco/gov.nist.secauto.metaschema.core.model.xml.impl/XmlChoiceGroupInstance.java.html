<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XmlChoiceGroupInstance.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Metaschema Core API</a> &gt; <a href="index.source.html" class="el_package">gov.nist.secauto.metaschema.core.model.xml.impl</a> &gt; <span class="el_source">XmlChoiceGroupInstance.java</span></div><h1>XmlChoiceGroupInstance.java</h1><pre class="source lang-java linenums">/*
 * SPDX-FileCopyrightText: none
 * SPDX-License-Identifier: CC0-1.0
 */

package gov.nist.secauto.metaschema.core.model.xml.impl;

import gov.nist.secauto.metaschema.core.datatype.markup.MarkupMultiline;
import gov.nist.secauto.metaschema.core.model.AbstractChoiceGroupInstance;
import gov.nist.secauto.metaschema.core.model.IAssemblyDefinition;
import gov.nist.secauto.metaschema.core.model.IAssemblyInstanceGrouped;
import gov.nist.secauto.metaschema.core.model.IChoiceGroupInstance;
import gov.nist.secauto.metaschema.core.model.IFieldInstanceGrouped;
import gov.nist.secauto.metaschema.core.model.INamedModelInstanceGrouped;
import gov.nist.secauto.metaschema.core.model.JsonGroupAsBehavior;
import gov.nist.secauto.metaschema.core.model.XmlGroupAsBehavior;
import gov.nist.secauto.metaschema.core.model.xml.XmlModuleConstants;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.GroupedAssemblyReferenceType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.GroupedChoiceType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.GroupedFieldReferenceType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.GroupedInlineAssemblyDefinitionType;
import gov.nist.secauto.metaschema.core.model.xml.xmlbeans.GroupedInlineFieldDefinitionType;
import gov.nist.secauto.metaschema.core.util.ObjectUtils;

import org.apache.commons.lang3.tuple.Pair;
import org.apache.xmlbeans.XmlCursor;
import org.apache.xmlbeans.XmlObject;

import java.util.Map;

import javax.xml.namespace.QName;

import edu.umd.cs.findbugs.annotations.NonNull;
import nl.talsmasoftware.lazy4j.Lazy;

class XmlChoiceGroupInstance
    extends AbstractChoiceGroupInstance&lt;
        IAssemblyDefinition,
        INamedModelInstanceGrouped,
        IFieldInstanceGrouped,
        IAssemblyInstanceGrouped&gt; {
  @NonNull
  private final GroupedChoiceType xmlObject;
  @NonNull
  private final Lazy&lt;XmlModelContainer&gt; modelContainer;

  /**
   * Constructs a mutually exclusive choice between two possible objects.
   *
   * @param xmlObject
   *          the XML for the choice definition bound to Java objects
   * @param parent
   *          the parent container, either a choice or assembly
   */
  public XmlChoiceGroupInstance(
      @NonNull GroupedChoiceType xmlObject,
      @NonNull IAssemblyDefinition parent) {
<span class="fc" id="L58">    super(parent);</span>
<span class="fc" id="L59">    this.xmlObject = xmlObject;</span>
<span class="fc" id="L60">    this.modelContainer = ObjectUtils.notNull(Lazy.lazy(() -&gt; new XmlModelContainer(xmlObject, this)));</span>
<span class="fc" id="L61">  }</span>

  @Override
  public XmlModelContainer getModelContainer() {
<span class="fc" id="L65">    return ObjectUtils.notNull(modelContainer.get());</span>
  }

  @Override
  public IAssemblyDefinition getOwningDefinition() {
<span class="fc" id="L70">    return getParentContainer();</span>
  }

  // ----------------------------------------
  // - Start XmlBeans driven code - CPD-OFF -
  // ----------------------------------------

  /**
   * Get the underlying XML data.
   *
   * @return the underlying XML data
   */
  @NonNull
  protected GroupedChoiceType getXmlObject() {
<span class="fc" id="L84">    return xmlObject;</span>
  }

  @Override
  public String getJsonDiscriminatorProperty() {
<span class="nc bnc" id="L89" title="All 2 branches missed.">    return getXmlObject().isSetDiscriminator()</span>
<span class="nc" id="L90">        ? ObjectUtils.requireNonNull(getXmlObject().getDiscriminator())</span>
<span class="nc" id="L91">        : DEFAULT_JSON_DISCRIMINATOR_PROPERTY_NAME;</span>
  }

  @Override
  public String getJsonKeyFlagInstanceName() {
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">    return getXmlObject().isSetJsonKey() ? getXmlObject().getJsonKey().getFlagRef() : null;</span>
  }

  @Override
  public String getGroupAsName() {
<span class="fc" id="L101">    return getXmlObject().getGroupAs().getName();</span>
  }

  @Override
  public int getMinOccurs() {
<span class="nc" id="L106">    return XmlModelParser.getMinOccurs(getXmlObject().getMinOccurs());</span>
  }

  @Override
  public int getMaxOccurs() {
<span class="nc" id="L111">    return XmlModelParser.getMaxOccurs(getXmlObject().getMaxOccurs());</span>
  }

  @Override
  public JsonGroupAsBehavior getJsonGroupAsBehavior() {
<span class="nc" id="L116">    return XmlModelParser.getJsonGroupAsBehavior(getXmlObject().getGroupAs());</span>
  }

  @Override
  public XmlGroupAsBehavior getXmlGroupAsBehavior() {
<span class="nc" id="L121">    return XmlModelParser.getXmlGroupAsBehavior(getXmlObject().getGroupAs());</span>
  }

  @Override
  public MarkupMultiline getRemarks() {
    // remarks not supported
<span class="nc" id="L127">    return null;</span>
  }

  // -------------------------------------
  // - End XmlBeans driven code - CPD-ON -
  // -------------------------------------

  @SuppressWarnings(&quot;PMD.UseConcurrentHashMap&quot;)
  @NonNull
<span class="fc" id="L136">  private static final XmlObjectParser&lt;Pair&lt;IChoiceGroupInstance, XmlModelContainer&gt;&gt; XML_MODEL_PARSER</span>
<span class="fc" id="L137">      = new XmlObjectParser&lt;&gt;(ObjectUtils.notNull(</span>
<span class="fc" id="L138">          Map.ofEntries(</span>
<span class="fc" id="L139">              Map.entry(XmlModuleConstants.ASSEMBLY_QNAME, XmlChoiceGroupInstance::handleAssembly),</span>
<span class="fc" id="L140">              Map.entry(XmlModuleConstants.DEFINE_ASSEMBLY_QNAME, XmlChoiceGroupInstance::handleDefineAssembly),</span>
<span class="fc" id="L141">              Map.entry(XmlModuleConstants.FIELD_QNAME, XmlChoiceGroupInstance::handleField),</span>
<span class="fc" id="L142">              Map.entry(XmlModuleConstants.DEFINE_FIELD_QNAME, XmlChoiceGroupInstance::handleDefineField)))) {</span>

        @Override
        protected Handler&lt;Pair&lt;IChoiceGroupInstance, XmlModelContainer&gt;&gt;
            identifyHandler(XmlCursor cursor, XmlObject obj) {
          Handler&lt;Pair&lt;IChoiceGroupInstance, XmlModelContainer&gt;&gt; retval;
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">          if (obj instanceof GroupedFieldReferenceType) {</span>
<span class="nc" id="L149">            retval = XmlChoiceGroupInstance::handleField;</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">          } else if (obj instanceof GroupedInlineFieldDefinitionType) {</span>
<span class="nc" id="L151">            retval = XmlChoiceGroupInstance::handleDefineField;</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">          } else if (obj instanceof GroupedAssemblyReferenceType) {</span>
<span class="fc" id="L153">            retval = XmlChoiceGroupInstance::handleAssembly;</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">          } else if (obj instanceof GroupedInlineAssemblyDefinitionType) {</span>
<span class="fc" id="L155">            retval = XmlChoiceGroupInstance::handleDefineAssembly;</span>
          } else {
<span class="nc" id="L157">            retval = super.identifyHandler(cursor, obj);</span>
          }
<span class="fc" id="L159">          return retval;</span>
        }
      };

  private static void handleField( // NOPMD false positive
      @NonNull XmlObject obj,
      Pair&lt;IChoiceGroupInstance, XmlModelContainer&gt; state) {
<span class="nc" id="L166">    IFieldInstanceGrouped instance = new XmlGroupedFieldInstance(</span>
        (GroupedFieldReferenceType) obj,
<span class="nc" id="L168">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="nc" id="L169">    ObjectUtils.notNull(state.getRight()).append(instance);</span>
<span class="nc" id="L170">  }</span>

  private static void handleDefineField( // NOPMD false positive
      @NonNull XmlObject obj,
      Pair&lt;IChoiceGroupInstance, XmlModelContainer&gt; state) {
<span class="nc" id="L175">    IFieldInstanceGrouped instance = new XmlGroupedInlineFieldDefinition(</span>
        (GroupedInlineFieldDefinitionType) obj,
<span class="nc" id="L177">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="nc" id="L178">    ObjectUtils.notNull(state.getRight()).append(instance);</span>
<span class="nc" id="L179">  }</span>

  private static void handleAssembly( // NOPMD false positive
      @NonNull XmlObject obj,
      Pair&lt;IChoiceGroupInstance, XmlModelContainer&gt; state) {
<span class="fc" id="L184">    IAssemblyInstanceGrouped instance = new XmlGroupedAssemblyInstance(</span>
        (GroupedAssemblyReferenceType) obj,
<span class="fc" id="L186">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="fc" id="L187">    ObjectUtils.notNull(state.getRight()).append(instance);</span>
<span class="fc" id="L188">  }</span>

  private static void handleDefineAssembly( // NOPMD false positive
      @NonNull XmlObject obj,
      Pair&lt;IChoiceGroupInstance, XmlModelContainer&gt; state) {
<span class="fc" id="L193">    IAssemblyInstanceGrouped instance = new XmlGroupedInlineAssemblyDefinition(</span>
        (GroupedInlineAssemblyDefinitionType) obj,
<span class="fc" id="L195">        ObjectUtils.notNull(state.getLeft()));</span>
<span class="fc" id="L196">    ObjectUtils.notNull(state.getRight()).append(instance);</span>
<span class="fc" id="L197">  }</span>

  private static class XmlModelContainer
      extends DefaultGroupedModelContainerSupport&lt;
          INamedModelInstanceGrouped,
          IFieldInstanceGrouped,
          IAssemblyInstanceGrouped&gt; {

    /**
     * Parse a choice group XMLBeans object.
     *
     * @param xmlObject
     *          the XMLBeans object
     * @param parent
     *          the parent Metaschema node, either an assembly definition or choice
     */
    public XmlModelContainer(
        @NonNull GroupedChoiceType xmlObject,
<span class="fc" id="L215">        @NonNull IChoiceGroupInstance parent) {</span>
<span class="fc" id="L216">      XML_MODEL_PARSER.parse(xmlObject, Pair.of(parent, this));</span>
<span class="fc" id="L217">    }</span>

    public void append(@NonNull IFieldInstanceGrouped instance) {
<span class="nc" id="L220">      QName key = instance.getXmlQName();</span>
<span class="nc" id="L221">      getFieldInstanceMap().put(key, instance);</span>
<span class="nc" id="L222">      getNamedModelInstanceMap().put(key, instance);</span>
<span class="nc" id="L223">    }</span>

    public void append(@NonNull IAssemblyInstanceGrouped instance) {
<span class="fc" id="L226">      QName key = instance.getXmlQName();</span>
<span class="fc" id="L227">      getAssemblyInstanceMap().put(key, instance);</span>
<span class="fc" id="L228">      getNamedModelInstanceMap().put(key, instance);</span>
<span class="fc" id="L229">    }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>